<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TripLog — 우리의 여행 기록</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
  :root{
    --ke-blue:#003478;
    --ke-blue-2:#0050a0;
    --bg:#f5f9fc;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background:var(--bg); color:var(--ke-blue);
  }
  header{
    text-align:center; padding:18px 12px 8px;
  }
  header h1{margin:0; font-size:28px}
  header h2{margin:4px 0 0; font-weight:500; opacity:.8; font-size:16px}

  .screen{display:none; padding:16px}
  .screen.active{display:block}

  .cta{display:flex; justify-content:center; gap:12px; margin-top:14px}
  .btn{
    background:var(--ke-blue); color:#fff; border:none; border-radius:8px;
    padding:12px 18px; cursor:pointer; font-weight:700;
  }
  .btn:hover{background:var(--ke-blue-2)}
  .btn.secondary{background:#fff; color:var(--ke-blue); border:2px solid var(--ke-blue)}

  .tp-wrap{
    display:flex; gap:16px; max-width:1200px; margin:16px auto; padding:0 12px;
  }
  .ticket, .passport{
    flex:1; background:#fff; border:2px solid var(--ke-blue); border-radius:14px; padding:16px;
    box-shadow:0 8px 20px rgba(0,0,0,.06);
  }

  /* 탑승권(대한항공 톤) */
  .ticket{
    background:
      linear-gradient(135deg, rgba(0,52,120,.06), rgba(0,52,120,0) 40%) ,
      #fff;
    position:relative;
  }
  .ticket .stub{
    display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;
  }
  .big-route{
    display:flex; align-items:center; justify-content:space-between; gap:10px; margin:10px 0 14px;
    font-weight:900; font-size:26px;
  }
  .code{font-variant-numeric:tabular-nums}
  .ticket .meta{display:grid; grid-template-columns:repeat(2,1fr); gap:10px}
  .ticket .meta label{display:block; font-size:12px; opacity:.75}
  .ticket .meta .val{font-weight:700}
  .ticket input[type="text"]{
    width:100%; padding:10px 12px; border:1px solid #cfe0f5; border-radius:8px; font-size:16px;
  }

  /* 여권 */
  .passport .cover, .passport .inner{ text-align:center }
  .passport img{ max-width:220px; width:100%; border-radius:10px; border:2px solid #228b22; }
  .passport .cover img{ border-color:#228b22 }
  .passport .field{ margin:10px 0; text-align:left }
  .passport .field label{ font-size:12px; opacity:.75 }
  .passport .field input, .passport .field select{
    width:100%; padding:10px 12px; border:1px solid #cfe0f5; border-radius:8px; font-size:16px;
  }
  .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}

  #map{width:100%; height:calc(100vh - 120px)}
  .map-locked{ pointer-events:none; filter:saturate(.95) }

  /* plane marker (divIcon) */
  .plane{
    width:60px; height:60px; background:url('plane.png') center/contain no-repeat;
    transform-origin:50% 50%;
  }
  /* rainbow tail for Travel Master */
  .plane.master::after{
    content:""; position:absolute; left:-90px; top:24px; width:90px; height:12px;
    background:linear-gradient(90deg, red, orange, yellow, green, cyan, blue, violet);
    opacity:.8; border-radius:8px; filter:blur(0.3px);
  }

  /* taxi marker */
  .taxi{ width:50px; height:50px; background:url('taxi.png') center/contain no-repeat; }

  .top-right{
    position:fixed; right:12px; top:12px; z-index:1000; display:flex; gap:8px; flex-wrap:wrap;
  }

  .pill{
    background:#fff; border:1px solid #cfe0f5; border-radius:999px; padding:8px 12px; font-size:13px;
    box-shadow:0 6px 16px rgba(0,0,0,.06);
  }

  .hidden{display:none}
</style>
</head>
<body>
  <header>
    <h1>✈️ TripLog</h1>
    <h2>— 우리의 여행 기록 —</h2>
  </header>

  <!-- 시작 화면 -->
  <section id="start" class="screen active" style="text-align:center">
    <p>가족과 함께 여행을 기록해요.</p>
    <div class="cta">
      <button class="btn" id="btnStart">새 여행 시작</button>
    </div>
  </section>

  <!-- 여권 & 탑승권 -->
  <section id="pt" class="screen">
    <div class="tp-wrap">
      <!-- 좌: 탑승권 -->
      <article class="ticket">
        <div class="stub">
          <div style="font-weight:800">BOARDING PASS</div>
          <div class="pill">좌석 28A</div>
        </div>
        <div class="big-route">
          <span class="code">ICN</span>
          <span>→</span>
          <span id="dest-code" class="code">???</span>
        </div>
        <div class="meta">
          <div>
            <label>출발</label>
            <div class="val">대한민국 인천국제공항(ICN)</div>
          </div>
          <div>
            <label>도착 (국가/도시/지역 검색)</label>
            <input id="inp-dest" type="text" placeholder="예: 도쿄 / 일본 / 다낭 / 하와이 ..." />
          </div>
          <div>
            <label>탑승자</label>
            <div class="val" id="ticket-name">이름 미입력</div>
          </div>
          <div>
            <label>출발일</label>
            <div class="val" id="today"></div>
          </div>
        </div>
      </article>

      <!-- 우: 여권 -->
      <article class="passport">
        <h3 style="margin-top:0">여권</h3>
        <div id="passport-closed" class="cover">
          <img src="passport_cover.png" alt="여권 겉표지" />
          <div class="field" style="margin-top:12px">
            <label>여권 이름</label>
            <input id="inp-name" type="text" placeholder="여권 이름 입력" />
          </div>
          <div class="cta">
            <button class="btn" id="btnRegPass">등록</button>
          </div>
        </div>

        <div id="passport-opened" class="inner hidden">
          <img src="passport_open.png" alt="여권 내부" />
          <div class="field"><label>한글성명</label><div class="val" id="pass-name">-</div></div>
          <div class="field"><label>칭호</label><div class="val" id="pass-title">없음</div></div>
          <div class="field"><label>사진</label><input id="pass-photo" type="file" accept="image/*" /></div>
          <div class="row">
            <div class="field"><label>성(한글)</label><input id="pass-last" type="text" placeholder="성"></div>
            <div class="field"><label>이름(한글)</label><input id="pass-first" type="text" placeholder="이름"></div>
          </div>
          <div class="row">
            <div class="field"><label>생년월일</label><input id="pass-birth" type="date"></div>
            <div class="field">
              <label>성별</label>
              <select id="pass-gender"><option>선택</option><option>남</option><option>여</option><option>기타</option></select>
            </div>
          </div>
          <div class="cta">
            <button class="btn secondary" id="btnSavePass">저장</button>
          </div>
        </div>
      </article>
    </div>
    <div class="cta">
      <button class="btn" id="btnConfirm">확인</button>
    </div>
  </section>

  <!-- 지도 화면 -->
  <section id="mapwrap" class="screen">
    <div class="top-right">
      <div class="pill" id="pillUser">사용자: -</div>
      <div class="pill" id="pillTitle">칭호: 없음</div>
      <div class="pill" id="pillFlights">비행: 0회</div>
    </div>
    <div id="map" class="map-locked"></div>
    <div class="cta" style="position:fixed;left:12px;bottom:12px;z-index:1000;gap:8px">
      <button class="btn hidden" id="btnTaxi">택시 호출</button>
      <button class="btn secondary hidden" id="btnBackAirport">공항으로 돌아가기</button>
      <button class="btn secondary hidden" id="btnReturnKorea">귀국</button>
    </div>
  </section>

  <!-- 귀국 화면 -->
  <section id="returnwrap" class="screen" style="text-align:center">
    <h2>대한민국 도착! 🇰🇷</h2>
    <p>여행을 계속하시겠습니까?</p>
    <div class="cta">
      <button class="btn" id="btnContinue">계속하기</button>
      <button class="btn secondary" id="btnEnd">여행 종료</button>
    </div>
  </section>

<script>
/* =======================
   1) 공항 데이터 & 지역 매핑
   ======================= */
const AIRPORTS = {
  "대한민국":[
    {code:"ICN", name:"인천국제공항", lat:37.4602, lng:126.4407},
    {code:"GMP", name:"김포국제공항", lat:37.5583, lng:126.7906},
    {code:"CJU", name:"제주국제공항", lat:33.5071, lng:126.4928}
  ],
  "일본":[
    {code:"NRT", name:"도쿄 나리타 국제공항", lat:35.7719, lng:140.3929},
    {code:"HND", name:"도쿄 하네다 국제공항", lat:35.5494, lng:139.7798},
    {code:"KIX", name:"오사카 간사이 국제공항", lat:34.4273, lng:135.2441},
    {code:"NGO", name:"나고야 주부 국제공항", lat:34.8584, lng:136.8054},
    {code:"FUK", name:"후쿠오카 국제공항", lat:33.5902, lng:130.4510},
    {code:"CTS", name:"삿포로 신치토세 국제공항", lat:42.7752, lng:141.6923},
    {code:"OKA", name:"오키나와 나하 국제공항", lat:26.1958, lng:127.6459}
  ],
  "베트남":[
    {code:"SGN", name:"호치민 떤선낫 국제공항", lat:10.8188, lng:106.6518},
    {code:"HAN", name:"하노이 노이바이 국제공항", lat:21.2142, lng:105.8029},
    {code:"DAD", name:"다낭 국제공항", lat:16.0439, lng:108.1994},
    {code:"CXR", name:"나트랑 카무란 국제공항", lat:11.9986, lng:109.2194},
    {code:"PQC", name:"푸꾸옥 국제공항", lat:10.227, lng:103.967}
  ],
  "중국":[
    {code:"PEK", name:"베이징 서우두 국제공항", lat:40.0801, lng:116.5846},
    {code:"PKX", name:"베이징 다싱 국제공항", lat:39.5099, lng:116.4108},
    {code:"PVG", name:"상하이 푸둥 국제공항", lat:31.1443, lng:121.8083},
    {code:"SHA", name:"상하이 홍차오 국제공항", lat:31.1979, lng:121.3363},
    {code:"CAN", name:"광저우 바이윈 국제공항", lat:23.3924, lng:113.2988}
  ],
  "러시아":[
    {code:"SVO", name:"모스크바 셰레메티예보 국제공항", lat:55.9726, lng:37.4146},
    {code:"DME", name:"모스크바 도모데도보 국제공항", lat:55.4146, lng:37.9026},
    {code:"LED", name:"상트페테르부르크 풀코보 국제공항", lat:59.8003, lng:30.2625},
    {code:"VVO", name:"블라디보스토크 국제공항", lat:43.3989, lng:132.1483}
  ],
  "태국":[
    {code:"BKK", name:"방콕 수완나품 국제공항", lat:13.6900, lng:100.7501},
    {code:"DMK", name:"방콕 돈므앙 국제공항", lat:13.9125, lng:100.6067},
    {code:"HKT", name:"푸켓 국제공항", lat:8.1132, lng:98.3168},
    {code:"CNX", name:"치앙마이 국제공항", lat:18.7668, lng:98.9626},
    {code:"USM", name:"코사무이 국제공항", lat:9.5478, lng:100.0614}
  ],
  "말레이시아":[
    {code:"KUL", name:"쿠알라룸푸르 국제공항", lat:2.7456, lng:101.7072},
    {code:"PEN", name:"페낭 국제공항", lat:5.2971, lng:100.2760},
    {code:"LGK", name:"랑카위 국제공항", lat:6.3297, lng:99.7287},
    {code:"BKI", name:"코타키나발루 국제공항", lat:5.9372, lng:116.0512}
  ],
  "인도네시아":[
    {code:"CGK", name:"자카르타 수카르노하타 국제공항", lat:-6.1256, lng:106.6559},
    {code:"DPS", name:"발리 덴파사르 국제공항", lat:-8.7482, lng:115.1670},
    {code:"SUB", name:"수라바야 주안다 국제공항", lat:-7.3798, lng:112.7870}
  ],
  "필리핀":[
    {code:"MNL", name:"마닐라 니노이 아키노 국제공항", lat:14.5099, lng:121.0136},
    {code:"CEB", name:"세부 막탄 국제공항", lat:10.3093, lng:123.9794},
    {code:"CRK", name:"클락 국제공항", lat:15.1860, lng:120.5603},
    {code:"KLO", name:"칼리보 국제공항(보라카이)", lat:11.6794, lng:122.3760}
  ],
  "싱가포르":[
    {code:"SIN", name:"싱가포르 창이 국제공항", lat:1.3644, lng:103.9915}
  ],
  "라오스":[
    {code:"VTE", name:"비엔티안 왓타이 국제공항", lat:17.9883, lng:102.5630}
  ],
  "캄보디아":[
    {code:"PNH", name:"프놈펜 국제공항", lat:11.5466, lng:104.8440},
    {code:"REP", name:"씨엠립 국제공항", lat:13.4081, lng:103.8131}
  ],
  "미얀마":[
    {code:"RGN", name:"양곤 국제공항", lat:16.9073, lng:96.1332}
  ],
  "브루나이":[
    {code:"BWN", name:"반다르스리브가완 국제공항", lat:4.9442, lng:114.9283}
  ],
  "미국":[
    {code:"JFK", name:"뉴욕 JFK 국제공항", lat:40.6413, lng:-73.7781},
    {code:"LAX", name:"로스앤젤레스 국제공항", lat:33.9416, lng:-118.4085},
    {code:"SFO", name:"샌프란시스코 국제공항", lat:37.6213, lng:-122.3790},
    {code:"ORD", name:"시카고 오헤어 국제공항", lat:41.9742, lng:-87.9073},
    {code:"ATL", name:"애틀랜타 국제공항", lat:33.6407, lng:-84.4277},
    {code:"HNL", name:"호놀룰루 국제공항(하와이)", lat:21.3187, lng:-157.9225},
    {code:"GUM", name:"괌 국제공항", lat:13.4839, lng:144.7971},
    {code:"SPN", name:"사이판 국제공항", lat:15.119, lng:145.729}
  ],
  "캐나다":[
    {code:"YYZ", name:"토론토 피어슨 국제공항", lat:43.6777, lng:-79.6248},
    {code:"YVR", name:"밴쿠버 국제공항", lat:49.1951, lng:-123.1779}
  ],
  "영국":[
    {code:"LHR", name:"런던 히드로 국제공항", lat:51.4700, lng:-0.4543}
  ],
  "프랑스":[
    {code:"CDG", name:"파리 샤를드골 국제공항", lat:49.0097, lng:2.5479}
  ],
  "독일":[
    {code:"FRA", name:"프랑크푸르트 국제공항", lat:50.0379, lng:8.5622},
    {code:"MUC", name:"뮌헨 국제공항", lat:48.3538, lng:11.7861}
  ],
  "이탈리아":[
    {code:"FCO", name:"로마 피우미치노 국제공항", lat:41.8003, lng:12.2389}
  ],
  "스페인":[
    {code:"MAD", name:"마드리드 국제공항", lat:40.4983, lng:-3.5676},
    {code:"BCN", name:"바르셀로나 국제공항", lat:41.2974, lng:2.0833}
  ],
  "호주":[
    {code:"SYD", name:"시드니 국제공항", lat:-33.9399, lng:151.1753},
    {code:"MEL", name:"멜버른 국제공항", lat:-37.669, lng:144.841}
  ],
  "뉴질랜드":[
    {code:"AKL", name:"오클랜드 국제공항", lat:-37.0082, lng:174.7850}
  ],
  "홍콩":[
    {code:"HKG", name:"홍콩 첵랍콕 국제공항", lat:22.3080, lng:113.9185}
  ],
  "아랍에미리트":[
    {code:"DXB", name:"두바이 국제공항", lat:25.2532, lng:55.3657},
    {code:"AUH", name:"아부다비 국제공항", lat:24.4330, lng:54.6511}
  ],
  "카타르":[
    {code:"DOH", name:"도하 하마드 국제공항", lat:25.2736, lng:51.6081}
  ],
  "터키":[
    {code:"IST", name:"이스탄불 국제공항", lat:41.2753, lng:28.7519},
    {code:"SAW", name:"이스탄불 사비하 괵첸 국제공항", lat:40.8986, lng:29.3092}
  ],
  "이스라엘":[
    {code:"TLV", name:"텔아비브 벤구리온 국제공항", lat:32.005, lng:34.8854}
  ],
  "사우디아라비아":[
    {code:"JED", name:"제다 킹압둘아지즈 국제공항", lat:21.6796, lng:39.1565},
    {code:"RUH", name:"리야드 킹칼리드 국제공항", lat:24.9594, lng:46.7029}
  ],
  "브라질":[
    {code:"GRU", name:"상파울루 과룰류스 국제공항", lat:-23.4356, lng:-46.4731},
    {code:"GIG", name:"리우데자네이루 갈레앙 국제공항", lat:-22.8090, lng:-43.2506}
  ],
  "아르헨티나":[
    {code:"EZE", name:"부에노스아이레스 에세이사 국제공항", lat:-34.8222, lng:-58.5358}
  ],
  "칠레":[
    {code:"SCL", name:"산티아고 아르투로 메리노 베니테스 국제공항", lat:-33.3929, lng:-70.7858}
  ],
  "페루":[
    {code:"LIM", name:"리마 호르헤 차베스 국제공항", lat:-12.0219, lng:-77.1143}
  ],
  "콜롬비아":[
    {code:"BOG", name:"보고타 엘도라도 국제공항", lat:4.7016, lng:-74.1469}
  ],
  "남아프리카공화국":[
    {code:"JNB", name:"요하네스버그 OR 탐보 국제공항", lat:-26.1337, lng:28.2420},
    {code:"CPT", name:"케이프타운 국제공항", lat:-33.9715, lng:18.6021}
  ],
  "이집트":[
    {code:"CAI", name:"카이로 국제공항", lat:30.1219, lng:31.4056}
  ],
  "케냐":[
    {code:"NBO", name:"나이로비 조모 케냐타 국제공항", lat:-1.3192, lng:36.9278}
  ],
  "에티오피아":[
    {code:"ADD", name:"아디스아바바 볼레 국제공항", lat:8.9779, lng:38.7993}
  ],
  "모로코":[
    {code:"CMN", name:"카사블랑카 무함마드5세 국제공항", lat:33.3675, lng:-7.58997}
  ]
};

const REGION_TO_AIRPORT = {
  "서울":"ICN","인천":"ICN","김포":"GMP","제주":"CJU",
  "도쿄":"HND","나리타":"NRT","오사카":"KIX","나고야":"NGO","후쿠오카":"FUK","삿포로":"CTS","오키나와":"OKA",
  "호치민":"SGN","하노이":"HAN","다낭":"DAD","나트랑":"CXR","푸꾸옥":"PQC",
  "베이징":"PEK","다싱":"PKX","상하이":"PVG","홍차오":"SHA","광저우":"CAN",
  "모스크바":"SVO","상트페테르부르크":"LED","블라디보스토크":"VVO",
  "방콕":"BKK","푸켓":"HKT","치앙마이":"CNX","코사무이":"USM",
  "쿠알라룸푸르":"KUL","페낭":"PEN","랑카위":"LGK","코타키나발루":"BKI",
  "자카르타":"CGK","발리":"DPS","수라바야":"SUB",
  "마닐라":"MNL","세부":"CEB","클락":"CRK","보라카이":"KLO",
  "싱가포르":"SIN",
  "비엔티안":"VTE","프놈펜":"PNH","씨엠립":"REP","양곤":"RGN","반다르스리브가완":"BWN",
  "뉴욕":"JFK","로스앤젤레스":"LAX","샌프란시스코":"SFO","시카고":"ORD","애틀랜타":"ATL","하와이":"HNL","괌":"GUM","사이판":"SPN",
  "토론토":"YYZ","밴쿠버":"YVR",
  "런던":"LHR","파리":"CDG","프랑크푸르트":"FRA","뮌헨":"MUC","로마":"FCO","마드리드":"MAD","바르셀로나":"BCN",
  "시드니":"SYD","멜버른":"MEL","오클랜드":"AKL",
  "홍콩":"HKG",
  "두바이":"DXB","아부다비":"AUH","도하":"DOH","이스탄불":"IST","텔아비브":"TLV","제다":"JED","리야드":"RUH",
  "상파울루":"GRU","리우데자네이루":"GIG","부에노스아이레스":"EZE","산티아고":"SCL","리마":"LIM","보고타":"BOG",
  "요하네스버그":"JNB","케이프타운":"CPT","카이로":"CAI","나이로비":"NBO","아디스아바바":"ADD","카사블랑카":"CMN"
};

function findAirportByRegion(q){
  const code = REGION_TO_AIRPORT[q?.trim()];
  if(code){
    for(const c in AIRPORTS){
      const a = AIRPORTS[c].find(x=>x.code===code);
      if(a) return a;
    }
  }
  // 국가명인 경우 해당 국가 첫 공항
  if(AIRPORTS[q?.trim()]) return AIRPORTS[q.trim()][0];
  return null;
}

/* =======================
   2) 상태
   ======================= */
const ICN = AIRPORTS["대한민국"][0];
let user = { name:null, title:"없음", flights:0, memories:0 };
let map, planeMarker, taxiMarker, routeLine;
let currentAirport = ICN;
let destinationAirport = null;
let animLock = false; // 이동 중 잠금

/* =======================
   3) UI 준비
   ======================= */
const $ = s=>document.querySelector(s);
const $$ = s=>document.querySelectorAll(s);

function show(id){
  $$(".screen").forEach(el=>el.classList.remove("active"));
  $(id).classList.add("active");
}

$("#btnStart").onclick = ()=>{
  $("#today").textContent = new Date().toLocaleDateString("ko-KR");
  $("#ticket-name").textContent = (localStorage.getItem("passportName")||"이름 미입력");
  loadPassport();
  show("#pt");
};

$("#btnRegPass").onclick = ()=>{
  const name = $("#inp-name").value.trim();
  if(!name){ alert("여권 이름을 입력하세요."); return; }
  localStorage.setItem("passportName", name);
  user.name = name;
  $("#pass-name").textContent = name;
  $("#passport-closed").classList.add("hidden");
  $("#passport-opened").classList.remove("hidden");
  $("#ticket-name").textContent = name;
  $("#pillUser").textContent = "사용자: "+name;
};

$("#btnSavePass").onclick = ()=>{
  // 단순 저장 (추후 확장 가능)
  localStorage.setItem("passportTitle", user.title);
  alert("여권이 저장되었습니다.");
};

function loadPassport(){
  const savedName = localStorage.getItem("passportName");
  const savedTitle = localStorage.getItem("passportTitle")||"없음";
  if(savedName){
    user.name = savedName; user.title = savedTitle;
    $("#passport-closed").classList.add("hidden");
    $("#passport-opened").classList.remove("hidden");
    $("#pass-name").textContent = savedName;
    $("#pass-title").textContent = savedTitle;
    $("#ticket-name").textContent = savedName;
    $("#pillUser").textContent = "사용자: "+savedName;
    $("#pillTitle").textContent = "칭호: "+savedTitle;
  }else{
    $("#passport-closed").classList.remove("hidden");
    $("#passport-opened").classList.add("hidden");
  }
}

$("#btnConfirm").onclick = async ()=>{
  const name = user.name || $("#inp-name").value.trim();
  const destText = $("#inp-dest").value.trim();
  if(!name){ alert("여권 이름을 등록해주세요."); return; }
  if(!destText){ alert("도착지를 입력해주세요."); return; }

  const ap = findAirportByRegion(destText);
  if(!ap){
    alert("도착지를 찾을 수 없습니다. (도시/국가/지역명을 다시 시도)");
    return;
  }
  destinationAirport = ap;
  $("#dest-code").textContent = ap.code;

  show("#mapwrap");
  initMap();
  fly(ICN, ap);
};

/* =======================
   4) 지도 & 애니메이션
   ======================= */
function initMap(){
  map = L.map('map', { zoomControl:true }).setView([ICN.lat, ICN.lng], 4);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    maxZoom:19, attribution:'&copy; OpenStreetMap'
  }).addTo(map);

  // 초기 잠금
  lockMap(true);
  updatePills();
}

function lockMap(lock){
  animLock = lock;
  const m = $("#map");
  if(lock){ m.classList.add("map-locked"); }
  else{ m.classList.remove("map-locked"); }
  if(lock){
    map.dragging.disable();
    map.scrollWheelZoom.disable();
    map.doubleClickZoom.disable();
    map.boxZoom.disable();
    map.keyboard.disable();
  }else{
    map.dragging.enable();
    map.scrollWheelZoom.enable();
    map.doubleClickZoom.enable();
    map.boxZoom.enable();
    map.keyboard.enable();
  }
}

function makePlaneDivIcon(master=false){
  const className = master ? "plane master" : "plane";
  return L.divIcon({ className, iconSize:[60,60] });
}

function bearing(a,b){
  const toRad = d=>d*Math.PI/180;
  const y = Math.sin(toRad(b.lng-a.lng)) * Math.cos(toRad(b.lat));
  const x = Math.cos(toRad(a.lat))*Math.sin(toRad(b.lat)) -
            Math.sin(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.cos(toRad(b.lng-a.lng));
  let brng = Math.atan2(y,x)*180/Math.PI;
  return (brng+360)%360;
}

async function fly(from, to){
  lockMap(true);
  $("#btnTaxi").classList.add("hidden");
  $("#btnBackAirport").classList.add("hidden");
  $("#btnReturnKorea").classList.add("hidden");

  const planeIcon = makePlaneDivIcon(user.title.includes("트래블 마스터"));
  if(planeMarker) map.removeLayer(planeMarker);
  planeMarker = L.marker([from.lat, from.lng], { icon: planeIcon, interactive:false }).addTo(map);

  const totalMs = 15000, steps = 120, dt = totalMs/steps;
  let step = 0;
  const fromLatLng = {lat:from.lat, lng:from.lng};
  const toLatLng = {lat:to.lat, lng:to.lng};

  map.setView([from.lat, from.lng], 4);

  const interval = setInterval(()=>{
    step++;
    const t = step/steps;
    const lat = from.lat + (to.lat-from.lat)*t;
    const lng = from.lng + (to.lng-from.lng)*t;

    // 회전
    const br = bearing({lat,lng},{lat:to.lat,lng:to.lng});
    const el = planeMarker.getElement();
    if(el) el.style.transform = `rotate(${br}deg)`;

    planeMarker.setLatLng([lat,lng]);

    if(step>=steps){
      clearInterval(interval);
      // 도착
      user.flights++;
      updateTitlesByFlights();
      currentAirport = to;
      map.setView([to.lat, to.lng], 12);
      // 비행 종료시 지도 고정 유지
      lockMap(true);
      // 택시 버튼 표시
      $("#btnTaxi").classList.remove("hidden");
    }
  }, dt);
}

function updatePills(){
  $("#pillUser").textContent = "사용자: " + (user.name||"-");
  $("#pillTitle").textContent = "칭호: " + (user.title||"없음");
  $("#pillFlights").textContent = "비행: " + (user.flights||0) + "회";
}

function updateTitlesByFlights(){
  // 30회마다 랭크업 구조 (간단 단계 예시)
  let t = "없음";
  if(user.flights >= 150) t = "트래블 마스터";
  else if(user.flights >= 120) t = "엘리트 여행가";
  else if(user.flights >= 90) t = "프로 여행가";
  else if(user.flights >= 60) t = "아마추어 여행가";
  else if(user.flights >= 30) t = "루키 여행가";
  else if(user.flights >= 1) t = "초보 여행가";

  user.title = t;
  localStorage.setItem("passportTitle", t);
  $("#pass-title").textContent = t;
  updatePills();
}

/* =======================
   5) 택시 시스템
   ======================= */
$("#btnTaxi").onclick = async ()=>{
  if(animLock) return;
  askTaxiDestination();
};

async function askTaxiDestination(){
  const where = prompt("어디로 가시겠어요? (예: 호치민 / 신주쿠 / Notre Dame Cathedral)");
  if(!where) return;

  // 1) 공항/지역 매핑 우선
  const ap = findAirportByRegion(where);
  if(ap){
    // 도시 중앙 대신 공항이면, 공항에서 조금 벗어난 포인트로 이동
    const target = { lat: ap.lat + 0.04, lng: ap.lng + 0.04, label: ap.name };
    return moveTaxiTo(target);
  }

  // 2) 지오코딩 (Nominatim)
  try{
    const q = encodeURIComponent(where);
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${q}`;
    const res = await fetch(url, { headers: { "Accept-Language":"ko" }});
    const arr = await res.json();
    if(arr && arr.length){
      const p = arr[0];
      return moveTaxiTo({ lat: parseFloat(p.lat), lng: parseFloat(p.lon), label: p.display_name });
    }else{
      alert("지명을 찾을 수 없습니다. 다른 표현으로 시도해 주세요.");
    }
  }catch(e){
    console.error(e);
    alert("지오코딩 오류가 발생했습니다.");
  }
}

async function moveTaxiTo(target){
  // 택시 스폰 (공항 위치)
  if(taxiMarker) map.removeLayer(taxiMarker);
  taxiMarker = L.marker([currentAirport.lat, currentAirport.lng], {
    icon: L.divIcon({ className:"taxi", iconSize:[50,50] }),
    interactive:false
  }).addTo(map);

  // OSRM 경로 요청 (도로 따라 이동)
  try{
    lockMap(true);
    $("#btnTaxi").classList.add("hidden");
    $("#btnBackAirport").classList.add("hidden");
    $("#btnReturnKorea").classList.add("hidden");

    const start = `${currentAirport.lng},${currentAirport.lat}`;
    const end   = `${target.lng},${target.lat}`;
    const url = `https://router.project-osrm.org/route/v1/driving/${start};${end}?overview=full&geometries=geojson`;
    const res = await fetch(url);
    const data = await res.json();

    if(!data.routes || !data.routes.length){
      // 경로 없으면 직선 이동
      return animateTaxiLinear([currentAirport.lat, currentAirport.lng], [target.lat, target.lng]);
    }

    const coords = data.routes[0].geometry.coordinates.map(([x,y])=>[y,x]);
    if(routeLine) map.removeLayer(routeLine);
    routeLine = L.polyline(coords, { color:'#003478', weight:4, opacity:.6 }).addTo(map);
    map.fitBounds(routeLine.getBounds(), { padding:[50,50] });

    // 15초에 맞춰 경로 애니메이션
    const totalMs = 15000;
    const steps = coords.length;
    const dt = totalMs / steps;

    let i = 0;
    const timer = setInterval(()=>{
      if(i>=coords.length){
        clearInterval(timer);
        map.removeLayer(routeLine);
        arriveCity(target);
        return;
      }
      taxiMarker.setLatLng(coords[i]);
      i++;
    }, dt);

  }catch(e){
    console.error(e);
    // 실패 시 직선 이동
    animateTaxiLinear([currentAirport.lat, currentAirport.lng], [target.lat, target.lng]);
  }
}

function animateTaxiLinear(from, to){
  const totalMs = 15000, steps = 120, dt = totalMs/steps;
  let step=0;
  const timer = setInterval(()=>{
    step++;
    const t = step/steps;
    const lat = from[0] + (to[0]-from[0])*t;
    const lng = from[1] + (to[1]-from[1])*t;
    taxiMarker.setLatLng([lat,lng]);
    if(step>=steps){
      clearInterval(timer);
      arriveCity({lat:to[0], lng:to[1], label:"목적지"});
    }
  }, dt);
}

function arriveCity(target){
  lockMap(false); // 도착 후 자유 스크롤/줌 허용
  map.setView([target.lat, target.lng], 14);
  alert("도착했습니다! 추억을 등록해 보세요.");
  $("#btnBackAirport").classList.remove("hidden");
  $("#btnReturnKorea").classList.remove("hidden");
}

/* 공항 복귀 & 귀국 */
$("#btnBackAirport").onclick = ()=>{
  lockMap(true); // 공항으로 이동하는 동안 잠금
  if(routeLine) map.removeLayer(routeLine);
  if(taxiMarker) taxiMarker.setLatLng([currentAirport.lat, currentAirport.lng]);
  map.setView([currentAirport.lat, currentAirport.lng], 12);
  setTimeout(()=>{
    lockMap(true);
    $("#btnTaxi").classList.remove("hidden");
    $("#btnBackAirport").classList.add("hidden");
    $("#btnReturnKorea").classList.remove("hidden");
  }, 400);
};

$("#btnReturnKorea").onclick = ()=>{
  // 귀국: 현재 공항 -> 인천 비행 (15초)
  fly(currentAirport, ICN);
  // 도착 후 화면 전환
  setTimeout(()=>{
    show("#returnwrap");
    lockMap(true);
    $("#btnTaxi").classList.add("hidden");
    $("#btnBackAirport").classList.add("hidden");
    $("#btnReturnKorea").classList.add("hidden");
  }, 15500);
};

$("#btnContinue").onclick = ()=>{
  show("#pt");
  $("#inp-dest").value = "";
  $("#dest-code").textContent = "???";
  $("#ticket-name").textContent = user.name||"이름 미입력";
  $("#today").textContent = new Date().toLocaleDateString("ko-KR");
};

$("#btnEnd").onclick = ()=>{
  // 여행 종료: 초기화는 비행 횟수만 유지/또는 필요시 초기화
  show("#start");
};

/* 처음 진입 시 날짜 세팅 */
document.addEventListener("DOMContentLoaded", ()=>{
  $("#today").textContent = new Date().toLocaleDateString("ko-KR");
});
</script>
</body>
</html>