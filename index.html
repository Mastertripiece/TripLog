<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>TripLog â€” ìš°ë¦¬ì˜ ì—¬í–‰ ê¸°ë¡</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  :root{
    --ke-blue:#0a3d91; --ke-sky:#e7f3ff; --ink:#10243e; --muted:#6b7b98;
    --card:#ffffff; --accent:#7c57ff;
  }
  *{box-sizing:border-box}  body{margin:0;font-family:Inter,system-ui,Segoe UI,Apple SD Gothic Neo,Apple Color Emoji,AppleGothic,Arial,sans-serif;background:linear-gradient(180deg,#f5f9ff 0%, #eef6ff 100%);color:var(--ink)}
  .topbar{display:flex;align-items:center;gap:10px;padding:12px 16px;border-bottom:1px solid #dde7ff;background:#fff;position:sticky;top:0;z-index:10}
  .brand{font-weight:800;letter-spacing:.02em;color:var(--ke-blue)} .subtitle{font-size:.9rem;color:var(--muted)} .spacer{flex:1}
  #startScreen{min-height:calc(100vh - 56px);display:grid;grid-template-columns:1fr;gap:16px;padding:16px}
  @media (min-width:960px){ #startScreen{grid-template-columns:1.2fr .8fr} }
  .card{background:var(--card);border:1px solid #d7e3ff;border-radius:18px;box-shadow:0 8px 24px rgba(10,61,145,.08);overflow:hidden}
  .card-header{padding:14px 16px;border-bottom:1px dashed #e5e9f8;display:flex;align-items:center;gap:10px}
  .card-body{padding:16px}
  .ticket{position:relative}
  .ticket .ticket-top{background:linear-gradient(90deg,var(--accent) 0%, #9e85ff 100%);color:#fff;padding:14px 16px;font-weight:700;display:flex;align-items:center;justify-content:space-between}
  .ticket .ticket-top .mini{font-size:.78rem;font-weight:600;opacity:.85;letter-spacing:.04em}
  .ticket .row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:14px}
  .field{display:flex;flex-direction:column;gap:6px}
  .label{font-size:.8rem;color:var(--muted)}
  .input, select, .input-like{border:1px solid #cfe0ff;border-radius:12px;padding:10px 12px;font-size:1rem;background:#fff;width:100%}
  .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .btnPrimary{background:var(--ke-blue);color:#fff;border:none;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
  .btnGhost{background:transparent;color:var(--ke-blue);border:1px solid var(--ke-blue);border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
  .passport{display:flex;flex-direction:column;height:100%}
  .passport-cover{background:#0e2a3f;color:#e7f0ff;font-weight:800;letter-spacing:.08em;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.15);display:flex;align-items:center;justify-content:space-between}
  .passport-inner{background:#fff;color:#111;padding:16px}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:var(--ke-blue);color:#fff;font-weight:700;font-size:.9rem}
  .rowv{display:flex;flex-direction:column;gap:12px}
  .hint{font-size:.85rem;color:var(--muted)}
  #mapWrap{display:none;height:calc(100vh - 56px)} #map{height:100%;width:100%}
  .map-panel{position:absolute;left:12px;top:68px;z-index:1000;background:#fff;border:1px solid #d7e3ff;border-radius:16px;padding:12px;box-shadow:0 8px 24px rgba(10,61,145,.12);display:flex;flex-direction:column;gap:10px;width:min(92vw,380px)}
  .map-footer{position:absolute;right:12px;bottom:12px;z-index:1000;display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
  .plane, .taxi{position:absolute;pointer-events:auto;transform-origin:center center;z-index:800}
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:2000}
  .modal{background:#fff;border-radius:16px;max-width:420px;width:92vw;padding:16px;border:1px solid #e3ebff}
  .modal h3{margin:0 0 10px 0} .modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
  .toast{position:fixed;left:50%;bottom:-64px;transform:translateX(-50%);background:var(--ke-blue);color:#fff;padding:10px 14px;border-radius:12px;opacity:0;transition:.35s;z-index:2500;font-weight:700}
  .toast.on{bottom:22px;opacity:1}
  .mem-photo{width:100%;max-height:260px;object-fit:contain;border:1px solid #e6efff;border-radius:12px}
  .chip{border:1px solid #cfe0ff;border-radius:999px;padding:6px 10px;background:#f7fbff;color:#1c315e;font-weight:600}
  .muted{color:var(--muted)}
  .leaflet-routing-container{display:none} /* ê²½ë¡œ íŒ¨ë„ ìˆ¨ê¹€ */
</style>
</head>
<body>
<header class="topbar">
  <div class="brand">TripLog</div><div class="subtitle">ìš°ë¦¬ì˜ ì—¬í–‰ ê¸°ë¡</div><div class="spacer"></div>
  <button id="goToStart" class="btnGhost" style="display:none">ì²˜ìŒìœ¼ë¡œ</button>
</header>

<section id="startScreen">
  <!-- Ticket -->
  <div class="card ticket">
    <div class="ticket-top"><div>BOARDING PASS</div><div class="mini">TRIPLOG â€¢ PREMIUM</div></div>
    <div class="card-body">
      <div class="row">
        <div class="field"><span class="label">ì¶œë°œ êµ­ê°€</span><input id="fromCountry" class="input" value="ëŒ€í•œë¯¼êµ­" readonly /></div>
        <div class="field"><span class="label">ì¶œë°œ ê³µí•­</span><select id="fromAirport"></select></div>
      </div>
      <div class="row">
        <div class="field"><span class="label">ë„ì°© êµ­ê°€</span>
          <input id="toCountry" class="input" placeholder="ì˜ˆ: ì¼ë³¸, í”„ë‘ìŠ¤, ë¯¸êµ­" list="countryList"/><datalist id="countryList"></datalist>
        </div>
        <div class="field"><span class="label">ë„ì°© ê³µí•­</span><select id="toAirport"><option value="">êµ­ê°€ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</option></select></div>
      </div>
      <div class="row">
        <div class="field"><span class="label">ì¶œë°œ ë‚ ì§œ</span><input id="flightDate" type="date" class="input"/></div>
        <div class="field"><span class="label">ì¶œë°œ ì‹œê°„</span><input id="flightTime" type="time" class="input"/></div>
      </div>
      <div class="two" style="margin-top:10px">
        <div class="field"><span class="label">ê²Œì´íŠ¸</span><input id="gate" class="input" placeholder="ì˜ˆ: A12"/></div>
        <div class="field"><span class="label">ì¢Œì„</span><input id="seat" class="input" placeholder="ì˜ˆ: 12A"/></div>
      </div>
      <div style="display:flex;gap:10px;margin-top:16px">
        <button id="btnDepart" class="btnPrimary">ì¶œêµ­</button>
        <button id="btnClear" class="btnGhost" title="í¼ ì´ˆê¸°í™”">ì´ˆê¸°í™”</button>
      </div>
      <div class="hint" style="margin-top:8px">ë„ì°© êµ­ê°€/ê³µí•­ì„ ì„ íƒí•˜ê³  ì¶œêµ­. ë¹„í–‰ì€ ì•½ 15ì´ˆ ì§„í–‰ë©ë‹ˆë‹¤.</div>
    </div>
  </div>

  <!-- Passport -->
  <div class="card passport">
    <div class="passport-cover"><span>REPUBLIC OF KOREA Â· PASSPORT</span><span class="badge" id="rankBadge" style="display:none">ì´ˆë³´ ì—¬í–‰ì</span></div>
    <div class="passport-inner">
      <div class="rowv">
        <div class="field"><span class="label">ì—¬ê¶Œ ì´ë¦„</span><input id="travelerName" class="input" placeholder="ì˜ˆ: ì£¼ì€ì°¬" /></div>
        <div class="hint">ì—¬ê¶Œ ì´ë¦„ìœ¼ë¡œ ë¹„í–‰ íšŸìˆ˜Â·ì¶”ì–µ ê¸°ë¡ì´ ì €ì¥ë©ë‹ˆë‹¤.</div>
        <div class="field"><span class="label">í˜„ì¬ ë³´ìœ  ì¹­í˜¸</span>
          <div><span id="rankText" class="chip muted">ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”</span><span id="photoKing" class="chip" style="display:none">ì¶”ì–µ ì „ë‹¬ì</span></div>
        </div>
      </div>
      <div style="margin-top:12px;display:flex;gap:10px">
        <button id="savePassport" class="btnPrimary">ì—¬ê¶Œ ì €ì¥</button>
        <button id="switchUser" class="btnGhost">ë‹¤ë¥¸ ì´ë¦„ìœ¼ë¡œ</button>
      </div>
    </div>
  </div>
</section>

<!-- Map -->
<section id="mapWrap">
  <div id="map"></div>

  <div class="map-panel" id="regionPanel" style="display:none">
    <div style="font-weight:800;color:var(--ke-blue)">ë„ì°© ì™„ë£Œ â€¢ ì§€ì—­ ì„ íƒ</div>
    <div class="field"><span class="label">ë„ì‹œ/ì§€ì—­ ê²€ìƒ‰(í•œê¸€ OK)</span>
      <input id="regionInput" class="input" placeholder="ì˜ˆ: ë¬´ì´ë„¤, ì˜¤ì‚¬ì¹´, í‘¸ê¾¸ì˜¥" list="cityList"/><datalist id="cityList"></datalist>
    </div>
    <div class="field"><span class="label">ì„ íƒí•œ ë„ì°©ì§€</span><input id="chosenCity" class="input" placeholder="ë„ì‹œë¥¼ ì„ íƒí•˜ì„¸ìš”" readonly /></div>
    <div style="display:flex;gap:8px">
      <button id="btnGoRegion" class="btnPrimary">ì§€ì—­ìœ¼ë¡œ ì´ë™(íƒì‹œ)</button>
      <button id="btnBackHome" class="btnGhost">ê·€êµ­</button>
    </div>
    <div class="hint">ë„ì°© í›„ ì§€ë„ í´ë¦­ìœ¼ë¡œ ì¶”ì–µ ë“±ë¡. íƒì‹œëŠ” ê³µí•­ ì£¼ë³€ì„ ìˆœí™˜í•˜ë©°, íƒ­í•˜ë©´ ëª©ì ì§€ë¥¼ ë¬¼ì–´ë´…ë‹ˆë‹¤.</div>
  </div>

  <div class="map-footer"><button id="btnViewAll" class="btnGhost">ì¶”ì–µ ì „ì²´ ë³´ê¸°</button></div>

  <!-- âœˆï¸ Plane (emoji in a divIcon) -->
  <div id="planeEl" class="plane" style="display:none;font-size:34px;line-height:1">âœˆï¸</div>

  <!-- ğŸš• Taxi (clean top-view SVG, no watermark) -->
  <div id="taxiEl" class="taxi" style="display:none">
    <svg width="44" height="24" viewBox="0 0 88 48">
      <rect x="6" y="6" width="76" height="36" rx="12" fill="#ffcc00" stroke="#222" stroke-width="3"/>
      <rect x="30" y="2" width="28" height="10" rx="3" fill="#ffd84d" stroke="#222" stroke-width="3"/>
      <rect x="18" y="10" width="52" height="12" rx="4" fill="#2a2a2a"/>
      <rect x="18" y="26" width="52" height="12" rx="4" fill="#2a2a2a"/>
    </svg>
  </div>
</section>

<!-- Memory Create Modal -->
<div id="memModal" class="modal-backdrop">
  <div class="modal">
    <h3 id="memTitle">ì¶”ì–µ ë“±ë¡</h3>
    <div class="field"><span class="label">ì¥ì†Œ ì´ë¦„(ìë™)</span><input id="memPlace" class="input" readonly /></div>
    <div class="field"><span class="label">ì‚¬ì§„</span><input id="memPhoto" type="file" accept="image/*" /></div>
    <div class="field"><span class="label">ë‚´ìš©</span><textarea id="memText" class="input" rows="4" placeholder="ì¶”ì–µì„ ì ì–´ì£¼ì„¸ìš”"></textarea></div>
    <div class="actions"><button class="btnGhost" id="memCancel">ì·¨ì†Œ</button><button class="btnPrimary" id="memSave">ì €ì¥</button></div>
  </div>
</div>

<!-- Memory View Modal -->
<div id="memView" class="modal-backdrop">
  <div class="modal">
    <h3 id="memViewTitle">ì¶”ì–µ ë³´ê¸°</h3>
    <img id="memViewImg" class="mem-photo" alt="photo"/><p id="memViewTxt" class="muted"></p><p id="memViewAuthor" class="muted"></p>
    <div class="actions"><button class="btnGhost" id="memPrev">â—€ ì´ì „</button><button class="btnGhost" id="memNext">ë‹¤ìŒ â–¶</button><button class="btnPrimary" id="memClose">ë‹«ê¸°</button></div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<!-- Optional routing (roads) -->
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css"/>

<script>
/* =========================
   ë°ì´í„°(ê³µí•­/ë„ì‹œ)
   ========================= */
const KOREA = { name:"ëŒ€í•œë¯¼êµ­", center:[37.5665,126.9780] };
const AIRPORTS = {
  "ëŒ€í•œë¯¼êµ­":[
    {code:"ICN", name:"ì¸ì²œêµ­ì œê³µí•­", lat:37.4602, lng:126.4407},
    {code:"GMP", name:"ê¹€í¬êµ­ì œê³µí•­", lat:37.5583, lng:126.7906}
  ],
  "ì¼ë³¸":[
    {code:"NRT", name:"ë‚˜ë¦¬íƒ€", lat:35.7719, lng:140.3929},
    {code:"HND", name:"í•˜ë„¤ë‹¤", lat:35.5494, lng:139.7798},
    {code:"KIX", name:"ê°„ì‚¬ì´", lat:34.4273, lng:135.2441},
    {code:"NGO", name:"ì£¼ë¶€(ë‚˜ê³ ì•¼)", lat:34.8584, lng:136.8054},
    {code:"FUK", name:"í›„ì¿ ì˜¤ì¹´", lat:33.5902, lng:130.4510},
    {code:"CTS", name:"ì‹ ì¹˜í† ì„¸(ì‚¿í¬ë¡œ)", lat:42.7752, lng:141.6923},
    {code:"OKA", name:"ë‚˜í•˜(ì˜¤í‚¤ë‚˜ì™€)", lat:26.1958, lng:127.6459}
  ],
  "ë² íŠ¸ë‚¨":[
    {code:"SGN", name:"í˜¸ì¹˜ë¯¼(ë–¤ì„ ë‚«)", lat:10.8188, lng:106.6518},
    {code:"HAN", name:"í•˜ë…¸ì´(ë…¸ì´ë°”ì´)", lat:21.2142, lng:105.8029},
    {code:"DAD", name:"ë‹¤ë‚­", lat:16.0439, lng:108.1994},
    {code:"CXR", name:"ë‚˜íŠ¸ë‘(ì¹´ë®¤ëœ)", lat:11.9986, lng:109.2194},
    {code:"PQC", name:"í‘¸ê¾¸ì˜¥", lat:10.227, lng:103.967}
  ],
  "ì¤‘êµ­":[
    {code:"PEK", name:"ë² ì´ì§•(ì„œìš°ë‘)", lat:40.0801, lng:116.5846},
    {code:"PKX", name:"ë² ì´ì§•(ë‹¤ì‹±)", lat:39.5099, lng:116.4108},
    {code:"PVG", name:"ìƒí•˜ì´(í‘¸ë‘¥)", lat:31.1443, lng:121.8083},
    {code:"SHA", name:"ìƒí•˜ì´(í™ì°¨ì˜¤)", lat:31.1979, lng:121.3363},
    {code:"CAN", name:"ê´‘ì €ìš°(ë°”ì´ìœˆ)", lat:23.3924, lng:113.2988}
  ],
  "ë¯¸êµ­":[
    {code:"JFK", name:"ë‰´ìš• JFK", lat:40.6413, lng:-73.7781},
    {code:"LAX", name:"ë¡œìŠ¤ì•¤ì ¤ë ˆìŠ¤", lat:33.9416, lng:-118.4085},
    {code:"SFO", name:"ìƒŒí”„ë€ì‹œìŠ¤ì½”", lat:37.6213, lng:-122.3790},
    {code:"ORD", name:"ì‹œì¹´ê³  ì˜¤í—¤ì–´", lat:41.9742, lng:-87.9073},
    {code:"ATL", name:"ì• í‹€ëœíƒ€", lat:33.6407, lng:-84.4277}
  ],
  "ìºë‚˜ë‹¤":[
    {code:"YYZ", name:"í† ë¡ í†  í”¼ì–´ìŠ¨", lat:43.6777, lng:-79.6248},
    {code:"YVR", name:"ë°´ì¿ ë²„", lat:49.1951, lng:-123.1779}
  ],
  "ì˜êµ­":[ {code:"LHR", name:"ëŸ°ë˜ íˆë“œë¡œ", lat:51.4700, lng:-0.4543} ],
  "í”„ë‘ìŠ¤":[ {code:"CDG", name:"íŒŒë¦¬ ìƒ¤ë¥¼ë“œê³¨", lat:49.0097, lng:2.5479} ],
  "ë…ì¼":[
    {code:"FRA", name:"í”„ë‘í¬í‘¸ë¥´íŠ¸", lat:50.0379, lng:8.5622},
    {code:"MUC", name:"ë®Œí—¨", lat:48.3538, lng:11.7861}
  ],
  "ì´íƒˆë¦¬ì•„":[ {code:"FCO", name:"ë¡œë§ˆ í”¼ìš°ë¯¸ì¹˜ë…¸", lat:41.8003, lng:12.2389} ],
  "ìŠ¤í˜ì¸":[
    {code:"MAD", name:"ë§ˆë“œë¦¬ë“œ", lat:40.4983, lng:-3.5676},
    {code:"BCN", name:"ë°”ë¥´ì…€ë¡œë‚˜", lat:41.2974, lng:2.0833}
  ],
  "í˜¸ì£¼":[
    {code:"SYD", name:"ì‹œë“œë‹ˆ", lat:-33.9399, lng:151.1753},
    {code:"MEL", name:"ë©œë²„ë¥¸", lat:-37.669, lng:144.841}
  ],
  "ë‰´ì§ˆëœë“œ":[ {code:"AKL", name:"ì˜¤í´ëœë“œ", lat:-37.0082, lng:174.7850} ],
  "ëŸ¬ì‹œì•„":[
    {code:"SVO", name:"ëª¨ìŠ¤í¬ë°” ì…°ë ˆë©”í‹°ì˜ˆë³´", lat:55.9726, lng:37.4146},
    {code:"DME", name:"ëª¨ìŠ¤í¬ë°” ë„ëª¨ë°ë„ë³´", lat:55.4146, lng:37.9026},
    {code:"LED", name:"ìƒíŠ¸í˜í…Œë¥´ë¶€ë¥´í¬", lat:59.8003, lng:30.2625}
  ],
  "ì‹±ê°€í¬ë¥´":[ {code:"SIN", name:"ì°½ì´", lat:1.3644, lng:103.9915} ],
  "íƒœêµ­":[
    {code:"BKK", name:"ë°©ì½• ìˆ˜ì™„ë‚˜í’ˆ", lat:13.6900, lng:100.7501},
    {code:"DMK", name:"ë°©ì½• ëˆë¯€ì•™", lat:13.9125, lng:100.6067},
    {code:"HKT", name:"í‘¸ì¼“", lat:8.1132, lng:98.3168},
    {code:"CNX", name:"ì¹˜ì•™ë§ˆì´", lat:18.7668, lng:98.9626}
  ],
  "ë§ë ˆì´ì‹œì•„":[
    {code:"KUL", name:"ì¿ ì•Œë¼ë£¸í‘¸ë¥´", lat:2.7456, lng:101.7072},
    {code:"PEN", name:"í˜ë‚­", lat:5.2971, lng:100.2760},
    {code:"LGK", name:"ë‘ì¹´ìœ„", lat:6.3297, lng:99.7287}
  ],
  "ì¸ë„ë„¤ì‹œì•„":[
    {code:"CGK", name:"ìì¹´ë¥´íƒ€", lat:-6.1256, lng:106.6559},
    {code:"DPS", name:"ë°œë¦¬ ë´íŒŒì‚¬ë¥´", lat:-8.7482, lng:115.1670},
    {code:"SUB", name:"ìˆ˜ë¼ë°”ì•¼", lat:-7.3798, lng:112.7870}
  ],
  "í•„ë¦¬í•€":[
    {code:"MNL", name:"ë§ˆë‹ë¼", lat:14.5099, lng:121.0136},
    {code:"CEB", name:"ì„¸ë¶€", lat:10.3093, lng:123.9794}
  ],
  "ëŒ€ë§Œ":[
    {code:"TPE", name:"íƒ€ì˜¤ìœ„ì•ˆ(íƒ€ì´ë² ì´)", lat:25.0797, lng:121.2340},
    {code:"KHH", name:"ê°€ì˜¤ìŠ", lat:22.5771, lng:120.3493}
  ],
  "í™ì½©":[ {code:"HKG", name:"í™ì½© ì²µëì½•", lat:22.3080, lng:113.9185} ],
  "í„°í‚¤":[
    {code:"IST", name:"ì´ìŠ¤íƒ„ë¶ˆ", lat:41.2603, lng:28.7420},
    {code:"SAW", name:"ì‚¬ë¹„í•˜ ê´µì²¸", lat:40.8986, lng:29.3092}
  ],
  "ë©•ì‹œì½”":[{code:"MEX", name:"ë©•ì‹œì½”ì‹œí‹°", lat:19.4361, lng:-99.0719},{code:"CUN", name:"ì¹¸ì¿¤", lat:21.0365, lng:-86.8771}],
  "ì¹ ë ˆ":[ {code:"SCL", name:"ì‚°í‹°ì•„ê³ ", lat:-33.3929, lng:-70.7858} ],
  "ë¸Œë¼ì§ˆ":[ {code:"GRU", name:"ìƒíŒŒìš¸ë£¨ êµ¬ì•„ë£°ë¥˜ìŠ¤", lat:-23.4356, lng:-46.4731} ],
  "ì‚¬ìš°ë””ì•„ë¼ë¹„ì•„":[ {code:"RUH", name:"ë¦¬ì•¼ë“œ", lat:24.9576, lng:46.6988} ],
  "UAE":[ {code:"DXB", name:"ë‘ë°”ì´", lat:25.2532, lng:55.3657} ],
  "ì´ìŠ¤ë¼ì—˜":[ {code:"TLV", name:"í…”ì•„ë¹„ë¸Œ", lat:32.000, lng:34.870} ],
  "ë„¤ëœë€ë“œ":[ {code:"AMS", name:"ì•”ìŠ¤í…Œë¥´ë‹´", lat:52.3105, lng:4.7683} ],
  "ìŠ¤ì›¨ë´":[ {code:"ARN", name:"ìŠ¤í†¡í™€ë¦„", lat:59.6519, lng:17.9186} ],
  "ë…¸ë¥´ì›¨ì´":[ {code:"OSL", name:"ì˜¤ìŠ¬ë¡œ", lat:60.1942, lng:11.1004} ],
  "í•€ë€ë“œ":[ {code:"HEL", name:"í—¬ì‹±í‚¤", lat:60.3172, lng:24.9633} ],
  "ë´ë§ˆí¬":[ {code:"CPH", name:"ì½”íœí•˜ê²", lat:55.6180, lng:12.6508} ],
  "ìŠ¤ìœ„ìŠ¤":[ {code:"ZRH", name:"ì·¨ë¦¬íˆ", lat:47.4581, lng:8.5555} ],
  "ì˜¤ìŠ¤íŠ¸ë¦¬ì•„":[ {code:"VIE", name:"ë¹„ì—”ë‚˜", lat:48.1103, lng:16.5697} ],
  "ë²¨ê¸°ì—":[ {code:"BRU", name:"ë¸Œë¤¼ì…€", lat:50.9010, lng:4.4844} ],
  "í¬ë¥´íˆ¬ê°ˆ":[ {code:"LIS", name:"ë¦¬ìŠ¤ë³¸", lat:38.7742, lng:-9.1342} ],
  "ê·¸ë¦¬ìŠ¤":[ {code:"ATH", name:"ì•„í…Œë„¤", lat:37.9364, lng:23.9445} ],
  "í´ë€ë“œ":[ {code:"WAW", name:"ë°”ë¥´ìƒ¤ë°”", lat:52.1657, lng:20.9671} ],
  "ì²´ì½”":[ {code:"PRG", name:"í”„ë¼í•˜", lat:50.1062, lng:14.2669} ],
  "í—ê°€ë¦¬":[ {code:"BUD", name:"ë¶€ë‹¤í˜ìŠ¤íŠ¸", lat:47.4369, lng:19.2556} ],
  "ì•„ì¼ëœë“œ":[ {code:"DUB", name:"ë”ë¸”ë¦°", lat:53.4273, lng:-6.2436} ],
};
const COUNTRY_CENTERS = {
  "ëŒ€í•œë¯¼êµ­":[36.5,127.8],"ì¼ë³¸":[36.2,138.3],"ë² íŠ¸ë‚¨":[15.9,105.8],"ì¤‘êµ­":[35.9,104.2],
  "ë¯¸êµ­":[39.5,-98.35],"ìºë‚˜ë‹¤":[56.1,-106.3],"ì˜êµ­":[54.0,-2.5],"í”„ë‘ìŠ¤":[46.2,2.2],
  "ë…ì¼":[51.2,10.4],"ì´íƒˆë¦¬ì•„":[41.9,12.6],"ìŠ¤í˜ì¸":[40.2,-3.7],"í˜¸ì£¼":[-25.3,133.8],
  "ë‰´ì§ˆëœë“œ":[-41.8,172.9],"ëŸ¬ì‹œì•„":[61.5,105.3],"ì‹±ê°€í¬ë¥´":[1.35,103.82],"íƒœêµ­":[13.7,100.5],
  "ë§ë ˆì´ì‹œì•„":[4.2,102.0],"ì¸ë„ë„¤ì‹œì•„":[-2.5,118.0],"í•„ë¦¬í•€":[12.9,122.8],"ëŒ€ë§Œ":[23.7,121.0],
  "í™ì½©":[22.3,114.2],"í„°í‚¤":[39.0,35.0],"ë©•ì‹œì½”":[23.6,-102.5],"ì¹ ë ˆ":[-30.0,-71.0],
  "ë¸Œë¼ì§ˆ":[-14.2,-51.9],"ì‚¬ìš°ë””ì•„ë¼ë¹„ì•„":[24.7,46.7],"UAE":[24.3,54.3],"ì´ìŠ¤ë¼ì—˜":[31.05,34.85],
  "ë„¤ëœë€ë“œ":[52.1,5.3],"ìŠ¤ì›¨ë´":[60.1,18.64],"ë…¸ë¥´ì›¨ì´":[60.4,8.47],"í•€ë€ë“œ":[64.0,26.0],
  "ë´ë§ˆí¬":[56.2,10.0],"ìŠ¤ìœ„ìŠ¤":[46.8,8.23],"ì˜¤ìŠ¤íŠ¸ë¦¬ì•„":[47.5,14.5],"ë²¨ê¸°ì—":[50.5,4.47],
  "í¬ë¥´íˆ¬ê°ˆ":[39.4,-8.2],"ê·¸ë¦¬ìŠ¤":[39.0,22.0],"í´ë€ë“œ":[52.0,19.0],"ì²´ì½”":[49.8,15.5],
  "í—ê°€ë¦¬":[47.1,19.4],"ì•„ì¼ëœë“œ":[53.1,-8.2],
};
/* ë„ì‹œ(ì˜ˆì‹œ + ì„¬) */
const CITIES = {
  "ì¼ë³¸":[{name:"ë„ì¿„",lat:35.6762,lng:139.6503},{name:"ì˜¤ì‚¬ì¹´",lat:34.6937,lng:135.5023},{name:"í›„ì¿ ì˜¤ì¹´",lat:33.5902,lng:130.4017},{name:"ì‚¿í¬ë¡œ",lat:43.0618,lng:141.3545},{name:"ì˜¤í‚¤ë‚˜ì™€",lat:26.2124,lng:127.6809},{name:"ë‚˜ê³ ì•¼",lat:35.1815,lng:136.9066},{name:"êµí† ",lat:35.0116,lng:135.7681}],
  "ë² íŠ¸ë‚¨":[{name:"í˜¸ì¹˜ë¯¼",lat:10.8231,lng:106.6297},{name:"í•˜ë…¸ì´",lat:21.0278,lng:105.8342},{name:"ë‹¤ë‚­",lat:16.0544,lng:108.2022},{name:"ë‚˜íŠ¸ë‘",lat:12.2388,lng:109.1967},{name:"í‘¸ê¾¸ì˜¥",lat:10.2897,lng:103.9840},{name:"ë¬´ì´ë„¤",lat:10.9333,lng:108.2833}],
  "í”„ë‘ìŠ¤":[{name:"íŒŒë¦¬",lat:48.8566,lng:2.3522},{name:"ë‹ˆìŠ¤",lat:43.7102,lng:7.2620},{name:"ë¦¬ì˜¹",lat:45.7640,lng:4.8357},{name:"ë³´ë¥´ë„",lat:44.8378,lng:-0.5792}],
  "ëŒ€í•œë¯¼êµ­":[{name:"ì œì£¼ë„",lat:33.4890,lng:126.4983}],
  "ì¤‘êµ­":[{name:"ë² ì´ì§•",lat:39.9042,lng:116.4074},{name:"ìƒí•˜ì´",lat:31.2304,lng:121.4737},{name:"ê´‘ì €ìš°",lat:23.1291,lng:113.2644}],
  "ë¯¸êµ­":[{name:"ë‰´ìš•",lat:40.7128,lng:-74.0060},{name:"ìƒŒí”„ë€ì‹œìŠ¤ì½”",lat:37.7749,lng:-122.4194},{name:"ë¡œìŠ¤ì•¤ì ¤ë ˆìŠ¤",lat:34.0522,lng:-118.2437},{name:"ì‹œì¹´ê³ ",lat:41.8781,lng:-87.6298}],
};
/* ì„¬ ì´ë¦„ì„ êµ­ê°€ ì—†ì´ ê²€ìƒ‰í–ˆì„ ë•Œ ë„ì›€ìš© */
const ISLAND_HINTS = {"ì œì£¼ë„":[33.4890,126.4983],"í‘¸ê¾¸ì˜¥":[10.2897,103.9840],"ë°œë¦¬":[-8.4095,115.1889]};

const ALL_COUNTRIES = Object.keys(COUNTRY_CENTERS);

/* =========================
   DB (localStorage)
   ========================= */
const DB_KEY='triplog';
let DB = JSON.parse(localStorage.getItem(DB_KEY)||'{"users":{},"memories":[]}');
function saveDB(){ localStorage.setItem(DB_KEY, JSON.stringify(DB)); }
function ensureUser(name){ if(!DB.users[name]) DB.users[name]={flights:0,photos:0}; }
function getFlights(name){ return DB.users[name]?.flights||0; }
function getPhotos(name){ return DB.users[name]?.photos||0; }
function incFlight(name){ ensureUser(name); const before=getFlights(name); DB.users[name].flights=before+1; saveDB(); checkRankUp(before, before+1); updateBadges(name); }
function incPhoto(name){ ensureUser(name); DB.users[name].photos=getPhotos(name)+1; saveDB(); updateBadges(name); }
function topPhotographer(){ let max=-1, who=null; for(const [n,u] of Object.entries(DB.users)){ if(u.photos>max){ max=u.photos; who=n; } } return who; }

/* =========================
   Ranks
   ========================= */
function rankByFlights(n){
  if(n>=200) return 'íŠ¸ë˜ë¸” ë§ˆìŠ¤í„°';
  if(n>=150) return 'ì—˜ë¦¬íŠ¸ ì—¬í–‰ì';
  if(n>=100) return 'í”„ë¡œ ì—¬í–‰ì';
  if(n>=60) return 'ì•„ë§ˆì¶”ì–´ ì—¬í–‰ì';
  if(n>=30) return 'ë£¨í‚¤ ì—¬í–‰ì';
  return 'ì´ˆë³´ ì—¬í–‰ì';
}
function updateBadges(name){
  const badge=document.getElementById('rankBadge');
  const chip=document.getElementById('rankText');
  const king=document.getElementById('photoKing');
  const r = rankByFlights(getFlights(name));
  if(badge){ badge.textContent=r; badge.style.display='inline-flex'; }
  if(chip){ chip.textContent=r; }
  const who=topPhotographer();
  if(king){ king.style.display = (who===name && getPhotos(name)>0) ? 'inline-flex':'none'; }
}
function toast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('on'); setTimeout(()=>t.classList.remove('on'),2000); }
function checkRankUp(before, after){ if(rankByFlights(before)!==rankByFlights(after)){ toast(`ì¡°ê±´ ë‹¬ì„±! ì¹­í˜¸ íšë“: ${rankByFlights(after)}`); } }

/* =========================
   UI refs
   ========================= */
const elStart = document.getElementById('startScreen');
const elMapWrap = document.getElementById('mapWrap');
const elGoStart = document.getElementById('goToStart');
const elFromAirport = document.getElementById('fromAirport');
const elToCountry = document.getElementById('toCountry');
const elToAirport = document.getElementById('toAirport');
const elCountryList = document.getElementById('countryList');
const elCityList = document.getElementById('cityList');
const elTravelerName = document.getElementById('travelerName');
const elSavePassport = document.getElementById('savePassport');
const elSwitchUser = document.getElementById('switchUser');
const elBtnDepart = document.getElementById('btnDepart');
const elBtnClear = document.getElementById('btnClear');
const regionPanel = document.getElementById('regionPanel');
const regionInput = document.getElementById('regionInput');
const chosenCity = document.getElementById('chosenCity');
const btnGoRegion = document.getElementById('btnGoRegion');
const btnBackHome = document.getElementById('btnBackHome');
const btnViewAll = document.getElementById('btnViewAll');
/* Memories modal */
const memModal = document.getElementById('memModal');
const memPlace = document.getElementById('memPlace');
const memPhoto = document.getElementById('memPhoto');
const memText = document.getElementById('memText');
const memCancel = document.getElementById('memCancel');
const memSave = document.getElementById('memSave');
/* Memory view */
const memView = document.getElementById('memView');
const memViewTitle = document.getElementById('memViewTitle');
const memViewImg = document.getElementById('memViewImg');
const memViewTxt = document.getElementById('memViewTxt');
const memViewAuthor = document.getElementById('memViewAuthor');
const memPrev = document.getElementById('memPrev');
const memNext = document.getElementById('memNext');
const memClose = document.getElementById('memClose');
/* Vehicle elements */
const planeEl = document.getElementById('planeEl');
const taxiEl = document.getElementById('taxiEl');

/* state */
let map, currentUser=null;
let currentMemories=[]; let currentMemIndex=0; let markers=[];
let isFlying=false, isTaxiMoving=false;
let maxBoundsLock=null; // ì§€ì—­ ë„ì°© í›„ ì œí•œ
let planeMarker=null, taxiMarker=null;
let wanderingTimer=null;

/* ========= init ========= */
function init(){
  // ì±„ìš°ê¸°
  Object.keys(AIRPORTS["ëŒ€í•œë¯¼êµ­"]).forEach(()=>{}); // no-op
  AIRPORTS["ëŒ€í•œë¯¼êµ­"].forEach(a=>{
    const o=document.createElement('option'); o.value=a.code; o.textContent=`${a.name} (${a.code})`; elFromAirport.appendChild(o);
  });
  ALL_COUNTRIES.forEach(c=>{ const o=document.createElement('option'); o.value=c; elCountryList.appendChild(o); });

  const last=localStorage.getItem('triplog_last_user');
  if(last){ elTravelerName.value=last; ensureUser(last); updateBadges(last); currentUser=last; }

  elToCountry.addEventListener('change', ()=>{ buildAirportList(); buildCityList(); });

  elSavePassport.addEventListener('click', ()=>{
    const name=(elTravelerName.value||'').trim(); if(!name){ alert('ì—¬ê¶Œ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”'); return; }
    currentUser=name; ensureUser(name); saveDB(); localStorage.setItem('triplog_last_user', name); updateBadges(name); toast(`ì—¬ê¶Œ ì €ì¥: ${name}`);
  });
  elSwitchUser.addEventListener('click', ()=>{ elTravelerName.value=''; currentUser=null; document.getElementById('rankBadge').style.display='none'; document.getElementById('rankText').textContent='ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”'; document.getElementById('photoKing').style.display='none'; });

  elBtnClear.addEventListener('click', ()=>{ elToCountry.value=''; elToAirport.innerHTML='<option value="">êµ­ê°€ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</option>'; document.getElementById('flightDate').value=''; document.getElementById('flightTime').value=''; document.getElementById('gate').value=''; document.getElementById('seat').value=''; });

  elBtnDepart.addEventListener('click', startFlight);
  elGoStart.addEventListener('click', ()=>{ switchToStart(); });

  btnGoRegion.addEventListener('click', ()=> promptTaxiGo());
  btnBackHome.addEventListener('click', goHome);
  btnViewAll.addEventListener('click', ()=> openMemViewAll());

  memCancel.onclick=()=>{ memModal.style.display='none'; if(tempMarkerRef){ map.removeLayer(tempMarkerRef); tempMarkerRef=null; } };
  memSave.onclick=saveMemory;

  memPrev.onclick=()=>{ if(!currentMemories.length) return; currentMemIndex=(currentMemIndex-1+currentMemories.length)%currentMemories.length; showMemSlide(); }
  memNext.onclick=()=>{ if(!currentMemories.length) return; currentMemIndex=(currentMemIndex+1)%currentMemories.length; showMemSlide(); }
  memClose.onclick=()=> memView.style.display='none';

  initMap();
  buildAirportList(); buildCityList();
}
function buildAirportList(){
  const c = (elToCountry.value||'').trim(); elToAirport.innerHTML='';
  if(AIRPORTS[c] && AIRPORTS[c].length){
    AIRPORTS[c].forEach(a=>{ const o=document.createElement('option'); o.value=a.code; o.textContent=`${a.name} (${a.code})`; elToAirport.appendChild(o); });
  }else{ const o=document.createElement('option'); o.value=''; o.textContent='ê³µí•­ ë¯¸ë“±ë¡(êµ­ê°€ ì¤‘ì‹¬ìœ¼ë¡œ ë¹„í–‰)'; elToAirport.appendChild(o); }
}
function buildCityList(){
  const c=(elToCountry.value||'').trim(); elCityList.innerHTML='';
  if(CITIES[c]) CITIES[c].forEach(ct=>{ const o=document.createElement('option'); o.value=ct.name; elCityList.appendChild(o); });
}

/* ============ Map ============ */
function initMap(){
  if(map) return;
  map = L.map('map',{worldCopyJump:true}).setView(KOREA.center, 5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom: 19 }).addTo(map);

  // ì¶”ì–µ ë“±ë¡: ë¹„í–‰/ì£¼í–‰ ì¤‘ì—” ê¸ˆì§€
  map.on('click', (e)=>{
    if(isFlying || isTaxiMoving){ toast('ì´ë™ ì¤‘ì—ëŠ” ì¶”ì–µì„ ë“±ë¡í•  ìˆ˜ ì—†ì–´ìš”.'); return; }
    openMemoryEditorAt(e.latlng, autoPlaceLabel(e.latlng));
  });

  renderAllMemories();
}

/* ============ Flight ============ */
function startFlight(){
  if(!currentUser){ alert('ì—¬ê¶Œ ì´ë¦„ì„ ë¨¼ì € ì €ì¥í•˜ì„¸ìš”.'); return; }
  const toC=(elToCountry.value||'').trim();
  if(!toC){ alert('ë„ì°© êµ­ê°€ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }

  stopWandering(); unlockBounds();

  const from = AIRPORTS["ëŒ€í•œë¯¼êµ­"].find(a=>a.code===elFromAirport.value) || AIRPORTS["ëŒ€í•œë¯¼êµ­"][0];
  let destCoord, airportLabel='';
  const toAirportCode = elToAirport.value;

  if(toAirportCode && AIRPORTS[toC]){
    const ap = AIRPORTS[toC].find(a=>a.code===toAirportCode);
    if(ap){ destCoord=[ap.lat, ap.lng]; airportLabel=`${toC} ${ap.name}`; }
  }
  if(!destCoord){ destCoord = COUNTRY_CENTERS[toC] || COUNTRY_CENTERS["ëŒ€í•œë¯¼êµ­"]; airportLabel=`${toC} ì¤‘ì‹¬`; }

  switchToMap();

  const start=[from.lat, from.lng], end=destCoord;
  // âœˆï¸ plane marker (divIcon with emoji)
  if(planeMarker){ map.removeLayer(planeMarker); }
  const icon = L.divIcon({html:'<div style="font-size:34px;transform:translate(-50%,-50%)">âœˆï¸</div>',className:''});
  planeMarker = L.marker(start,{icon, interactive:false}).addTo(map);

  // Progressive zoom during flight
  isFlying=true;
  const flightMs=15000, steps=6;
  const line = L.polyline([start, end], {color:'#1b4fa3', weight:3, opacity:.85}).addTo(map);
  let t0;
  function step(ts){
    if(!t0) t0=ts;
    const p=Math.min(1,(ts-t0)/flightMs);
    const cur=lerpLatLng(start,end,p);
    planeMarker.setLatLng(cur);
    // rotate
    const angle = bearingDeg(prevPos||start, cur); prevPos=cur;
    planeEl.style.display='block'; // show guide (CSS plane div is not used for position; marker is)
    planeMarker._icon.style.transform=`translate(-50%,-50%) rotate(${angle}deg)`;
    // zoom schedule
    const z = 4 + Math.floor(p*steps); // 4 -> 10
    map.setView(cur, Math.min(10,z), {animate:false});
    if(p<1) requestAnimationFrame(step);
    else {
      isFlying=false;
      toast(`ì°©ë¥™: ${airportLabel}`);
      incFlight(currentUser);
      map.flyTo(end, 11, {duration:1.2});
      regionPanel.style.display='flex';
      startTaxiWandering(end);
    }
  }
  let prevPos=start;
  requestAnimationFrame(step);
}
function bearingDeg(a,b){
  const toRad=x=>x*Math.PI/180, toDeg=x=>x*180/Math.PI;
  const y=Math.sin(toRad(b[1]-a[1]))*Math.cos(toRad(b[0]));
  const x=Math.cos(toRad(a[0]))*Math.sin(toRad(b[0]))-Math.sin(toRad(a[0]))*Math.cos(toRad(b[0]))*Math.cos(toRad(b[1]-a[1]));
  return (toDeg(Math.atan2(y,x))+360)%360;
}

/* Taxi wandering near airport */
function startTaxiWandering(center){
  if(taxiMarker){ map.removeLayer(taxiMarker); taxiMarker=null; }
  const taxiIcon = L.divIcon({html: document.getElementById('taxiEl').innerHTML, className:'', iconSize:[44,24], iconAnchor:[22,12]});
  taxiMarker = L.marker(center,{icon:taxiIcon}).addTo(map);

  taxiMarker.on('click', ()=>{ if(isTaxiMoving||isFlying) return; promptTaxiGo(); });

  let angle=0;
  wanderingTimer = setInterval(()=>{
    if(isTaxiMoving) return;
    angle += (Math.random()*0.8-0.4);
    const r=0.01; // ì•½ 1km ë°˜ê²½
    const nx=center[0]+Math.sin(angle)*r, ny=center[1]+Math.cos(angle)*r;
    taxiMarker.setLatLng([nx,ny]);
  }, 900);
}
function stopWandering(){ if(wanderingTimer){ clearInterval(wanderingTimer); wanderingTimer=null; } }

/* Taxi go to a region (prompt + geocode + route) */
async function promptTaxiGo(){
  const toC=(elToCountry.value||'').trim();
  const input = (regionInput.value||'').trim() || prompt('ì–´ë””ë¡œ ê°€ì‹œê² ì–´ìš”? (ë„ì‹œ/ì§€ì—­ëª…ì„ ì…ë ¥)');
  if(!input) return;

  const dest = await geocodeGuess(input, toC);
  if(!dest){ alert('í•´ë‹¹ ì§€ì—­ì„ ì°¾ì§€ ëª»í–ˆì–´ìš”. ë‹¤ë¥¸ ì´ë¦„ìœ¼ë¡œ ì‹œë„í•´ ì£¼ì„¸ìš”.'); return; }

  chosenCity.value = dest.name;
  regionInput.value = dest.name;

  // route by OSRM (if available)
  isTaxiMoving=true; stopWandering();
  const start = taxiMarker.getLatLng();
  try{
    await routeAndDrive([start.lat,start.lng],[dest.lat,dest.lng],15000);
  }catch(e){
    await straightDrive([start.lat,start.lng],[dest.lat,dest.lng],15000);
  }
  isTaxiMoving=false;

  // zoom-in & lock bounds
  map.flyTo([dest.lat,dest.lng], 13, {duration:1});
  lockBoundsAround([dest.lat,dest.lng], 0.05); // ì•½ 5km ë°•ìŠ¤
  toast(`ë„ì°©: ${dest.name}. ì§€ë„ì—ì„œ ì¥ì†Œë¥¼ ëˆŒëŸ¬ ì¶”ì–µì„ ë“±ë¡í•˜ì„¸ìš”!`);
}

/* Routing with Leaflet Routing Machine (OSRM demo) */
function routeAndDrive(a,b,ms){
  return new Promise((resolve,reject)=>{
    const control = L.Routing.control({
      waypoints:[L.latLng(a[0],a[1]), L.latLng(b[0],b[1])],
      router: L.Routing.osrmv1({serviceUrl:'https://router.project-osrm.org/route/v1'}),
      addWaypoints:false, draggableWaypoints:false, fitSelectedRoutes:false, show:false
    }).addTo(map);
    control.on('routesfound', function(e){
      const line = L.polyline(e.routes[0].coordinates,{color:'#ff9900',weight:4,opacity:.9}).addTo(map);
      driveAlong(line.getLatLngs(), ms, ()=>{ map.removeControl(control); map.removeLayer(line); resolve(); });
    });
    control.on('routingerror', ()=>{ map.removeControl(control); reject('routing fail'); });
  });
}
/* straight fallback */
function straightDrive(a,b,ms){
  return new Promise((resolve)=>{
    const poly = L.polyline([a,b],{color:'#ff9900',weight:4,opacity:.8,dashArray:'6 6'}).addTo(map);
    driveAlong(poly.getLatLngs(), ms, ()=>{ map.removeLayer(poly); resolve(); });
  });
}
/* drive animation along coords */
function driveAlong(coords, duration, done){
  const total=coords.length; if(total<2){ done(); return; }
  const startT=performance.now();
  function step(t){
    const p=Math.min(1,(t-startT)/duration);
    const idx=Math.floor(p*(total-1));
    taxiMarker.setLatLng(coords[idx]);
    map.panTo(coords[idx], {animate:false});
    if(p<1) requestAnimationFrame(step); else done();
  }
  requestAnimationFrame(step);
}

/* Bounds lock */
function lockBoundsAround(center, delta){
  const sw=[center[0]-delta, center[1]-delta], ne=[center[0]+delta, center[1]+delta];
  maxBoundsLock = L.latLngBounds(sw,ne);
  map.setMaxBounds(maxBoundsLock);
}
function unlockBounds(){ map.setMaxBounds(null); maxBoundsLock=null; }

/* Geocode (í•œê¸€ OK) + ë³´ì¡° í…Œì´ë¸” */
async function geocodeGuess(q, country){
  // 1) ë‚´ì¥ í…Œì´ë¸” ìš°ì„ 
  const tbl = CITIES[country]||[];
  const hit = tbl.find(c=>c.name===q);
  if(hit) return {name:hit.name, lat:hit.lat, lng:hit.lng};

  // 2) ì„¬ íŒíŠ¸
  if(ISLAND_HINTS[q]){ const [lat,lng]=ISLAND_HINTS[q]; return {name:q, lat, lng}; }

  // 3) Nominatim
  const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q + (country?(' '+country):''))}`;
  const res = await fetch(url, {headers:{'Accept-Language':'ko'}});
  const data = await res.json();
  if(data && data.length){
    const d=data[0]; return {name:q, lat:parseFloat(d.lat), lng:parseFloat(d.lon)};
  }
  return null;
}

/* ============ Screen switch ============ */
function switchToMap(){ elStart.style.display='none'; elMapWrap.style.display='block'; elGoStart.style.display='inline-flex'; }
function switchToStart(){ elMapWrap.style.display='none'; elStart.style.display='grid'; elGoStart.style.display='none'; stopWandering(); unlockBounds(); }

/* ============ Memories ============ */
let tempMarkerRef=null;
function autoPlaceLabel(latlng){
  const toC=(elToCountry.value||'').trim();
  const city = (chosenCity.value||regionInput.value||'').trim();
  if(city) return `${toC?toC+' ':''}${city}`;
  return `(${latlng.lat.toFixed(3)}, ${latlng.lng.toFixed(3)})`;
}
function openMemoryEditorAt(latlng, label){
  if(tempMarkerRef){ map.removeLayer(tempMarkerRef); tempMarkerRef=null; }
  tempMarkerRef=L.marker(latlng).addTo(map);
  memPlace.value=label;
  memModal.style.display='flex';
  memModal.dataset.lat=latlng.lat;
  memModal.dataset.lng=latlng.lng;
}
function saveMemory(){
  const name=currentUser||'ìµëª…';
  const place=memPlace.value||'ë¯¸ì§€ì •';
  const lat=parseFloat(memModal.dataset.lat);
  const lng=parseFloat(memModal.dataset.lng);
  const text=memText.value||'';
  const file=memPhoto.files[0];

  function cleanup(){
    memModal.style.display='none';
    memPhoto.value=''; memText.value='';
    if(tempMarkerRef){ map.removeLayer(tempMarkerRef); tempMarkerRef=null; }
  }

  // ë‚´ìš©ê³¼ ì‚¬ì§„ ëª¨ë‘ ì—†ìœ¼ë©´ ì €ì¥ ì•ˆ í•¨
  if(!text && !file){ cleanup(); return; }

  const done=(photoData)=>{
    DB.memories.push({place, lat, lng, text, photo:photoData||'', author:name, ts:Date.now()});
    saveDB(); incPhoto(name); cleanup(); renderAllMemories(); toast('ì¶”ì–µì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
  };

  if(file){
    const reader=new FileReader(); reader.onload=(e)=> done(e.target.result); reader.readAsDataURL(file);
  }else{ done(''); }
}
function renderAllMemories(){
  markers.forEach(m=> m.remove()); markers.length=0;
  DB.memories.forEach((m)=>{ const mk=L.marker([m.lat,m.lng]).addTo(map); mk.on('click', ()=> openMemAt(m.lat, m.lng)); markers.push(mk); });
}
function openMemAt(lat,lng){
  const list = DB.memories.filter(x=>Math.abs(x.lat-lat)<1e-6 && Math.abs(x.lng-lng)<1e-6);
  if(!list.length) return;
  currentMemories=list.sort((a,b)=>a.ts-b.ts); currentMemIndex=0; showMemSlide(); memView.style.display='flex';
}
function openMemViewAll(){
  if(!DB.memories.length){ alert('ì €ì¥ëœ ì¶”ì–µì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
  currentMemories=DB.memories.slice().sort((a,b)=>a.ts-b.ts); currentMemIndex=0; showMemSlide(); memView.style.display='flex';
}
function showMemSlide(){
  const m=currentMemories[currentMemIndex];
  memViewTitle.textContent=m.place; memViewTxt.textContent=m.text||'(ë‚´ìš© ì—†ìŒ)'; memViewAuthor.textContent=`ì‘ì„±ì: ${m.author}`;
  if(m.photo){ memViewImg.src=m.photo; memViewImg.style.display='block'; } else { memViewImg.removeAttribute('src'); memViewImg.style.display='none'; }
}

/* ============ helpers ============ */
function lerpLatLng(a,b,p){ return [a[0]+(b[0]-a[0])*p, a[1]+(b[1]-a[1])*p]; }

/* kickoff */
function prime(){
  const d=new Date();
  document.getElementById('flightDate').value = d.toISOString().slice(0,10);
  document.getElementById('flightTime').value = String(d.getHours()).padStart(2,'0')+":"+String(d.getMinutes()).padStart(2,'0');
}
document.addEventListener('DOMContentLoaded', ()=>{ prime(); init(); });
</script>
</body>
</html>