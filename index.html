<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TripLog â€” ìš°ë¦¬ì˜ ì—¬í–‰ ê¸°ë¡</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
  :root{
    --ke-blue:#003478;
    --ke-blue-2:#0050a0;
    --bg:#f5f9fc;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background:var(--bg); color:var(--ke-blue);
  }
  header{
    text-align:center; padding:18px 12px 8px;
  }
  header h1{margin:0; font-size:28px}
  header h2{margin:4px 0 0; font-weight:500; opacity:.8; font-size:16px}

  .screen{display:none; padding:16px}
  .screen.active{display:block}

  .cta{display:flex; justify-content:center; gap:12px; margin-top:14px}
  .btn{
    background:var(--ke-blue); color:#fff; border:none; border-radius:8px;
    padding:12px 18px; cursor:pointer; font-weight:700;
  }
  .btn:hover{background:var(--ke-blue-2)}
  .btn.secondary{background:#fff; color:var(--ke-blue); border:2px solid var(--ke-blue)}

  .tp-wrap{
    display:flex; gap:16px; max-width:1200px; margin:16px auto; padding:0 12px;
  }
  .ticket, .passport{
    flex:1; background:#fff; border:2px solid var(--ke-blue); border-radius:14px; padding:16px;
    box-shadow:0 8px 20px rgba(0,0,0,.06);
  }

  /* íƒ‘ìŠ¹ê¶Œ(ëŒ€í•œí•­ê³µ í†¤) */
  .ticket{
    background:
      linear-gradient(135deg, rgba(0,52,120,.06), rgba(0,52,120,0) 40%) ,
      #fff;
    position:relative;
  }
  .ticket .stub{
    display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;
  }
  .big-route{
    display:flex; align-items:center; justify-content:space-between; gap:10px; margin:10px 0 14px;
    font-weight:900; font-size:26px;
  }
  .code{font-variant-numeric:tabular-nums}
  .ticket .meta{display:grid; grid-template-columns:repeat(2,1fr); gap:10px}
  .ticket .meta label{display:block; font-size:12px; opacity:.75}
  .ticket .meta .val{font-weight:700}
  .ticket input[type="text"]{
    width:100%; padding:10px 12px; border:1px solid #cfe0f5; border-radius:8px; font-size:16px;
  }

  /* ì—¬ê¶Œ */
  .passport .cover, .passport .inner{ text-align:center }
  .passport img{ max-width:220px; width:100%; border-radius:10px; border:2px solid #228b22; }
  .passport .cover img{ border-color:#228b22 }
  .passport .field{ margin:10px 0; text-align:left }
  .passport .field label{ font-size:12px; opacity:.75 }
  .passport .field input, .passport .field select{
    width:100%; padding:10px 12px; border:1px solid #cfe0f5; border-radius:8px; font-size:16px;
  }
  .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}

  #map{width:100%; height:calc(100vh - 120px)}
  .map-locked{ pointer-events:none; filter:saturate(.95) }

  /* plane marker (divIcon) */
  .plane{
    width:60px; height:60px; background:url('plane.png') center/contain no-repeat;
    transform-origin:50% 50%;
  }
  /* rainbow tail for Travel Master */
  .plane.master::after{
    content:""; position:absolute; left:-90px; top:24px; width:90px; height:12px;
    background:linear-gradient(90deg, red, orange, yellow, green, cyan, blue, violet);
    opacity:.8; border-radius:8px; filter:blur(0.3px);
  }

  /* taxi marker */
  .taxi{ width:50px; height:50px; background:url('taxi.png') center/contain no-repeat; }

  .top-right{
    position:fixed; right:12px; top:12px; z-index:1000; display:flex; gap:8px; flex-wrap:wrap;
  }

  .pill{
    background:#fff; border:1px solid #cfe0f5; border-radius:999px; padding:8px 12px; font-size:13px;
    box-shadow:0 6px 16px rgba(0,0,0,.06);
  }

  .hidden{display:none}
</style>
</head>
<body>
  <header>
    <h1>âœˆï¸ TripLog</h1>
    <h2>â€” ìš°ë¦¬ì˜ ì—¬í–‰ ê¸°ë¡ â€”</h2>
  </header>

  <!-- ì‹œì‘ í™”ë©´ -->
  <section id="start" class="screen active" style="text-align:center">
    <p>ê°€ì¡±ê³¼ í•¨ê»˜ ì—¬í–‰ì„ ê¸°ë¡í•´ìš”.</p>
    <div class="cta">
      <button class="btn" id="btnStart">ìƒˆ ì—¬í–‰ ì‹œì‘</button>
    </div>
  </section>

  <!-- ì—¬ê¶Œ & íƒ‘ìŠ¹ê¶Œ -->
  <section id="pt" class="screen">
    <div class="tp-wrap">
      <!-- ì¢Œ: íƒ‘ìŠ¹ê¶Œ -->
      <article class="ticket">
        <div class="stub">
          <div style="font-weight:800">BOARDING PASS</div>
          <div class="pill">ì¢Œì„ 28A</div>
        </div>
        <div class="big-route">
          <span class="code">ICN</span>
          <span>â†’</span>
          <span id="dest-code" class="code">???</span>
        </div>
        <div class="meta">
          <div>
            <label>ì¶œë°œ</label>
            <div class="val">ëŒ€í•œë¯¼êµ­ ì¸ì²œêµ­ì œê³µí•­(ICN)</div>
          </div>
          <div>
            <label>ë„ì°© (êµ­ê°€/ë„ì‹œ/ì§€ì—­ ê²€ìƒ‰)</label>
            <input id="inp-dest" type="text" placeholder="ì˜ˆ: ë„ì¿„ / ì¼ë³¸ / ë‹¤ë‚­ / í•˜ì™€ì´ ..." />
          </div>
          <div>
            <label>íƒ‘ìŠ¹ì</label>
            <div class="val" id="ticket-name">ì´ë¦„ ë¯¸ì…ë ¥</div>
          </div>
          <div>
            <label>ì¶œë°œì¼</label>
            <div class="val" id="today"></div>
          </div>
        </div>
      </article>

      <!-- ìš°: ì—¬ê¶Œ -->
      <article class="passport">
        <h3 style="margin-top:0">ì—¬ê¶Œ</h3>
        <div id="passport-closed" class="cover">
          <img src="passport_cover.png" alt="ì—¬ê¶Œ ê²‰í‘œì§€" />
          <div class="field" style="margin-top:12px">
            <label>ì—¬ê¶Œ ì´ë¦„</label>
            <input id="inp-name" type="text" placeholder="ì—¬ê¶Œ ì´ë¦„ ì…ë ¥" />
          </div>
          <div class="cta">
            <button class="btn" id="btnRegPass">ë“±ë¡</button>
          </div>
        </div>

        <div id="passport-opened" class="inner hidden">
          <img src="passport_open.png" alt="ì—¬ê¶Œ ë‚´ë¶€" />
          <div class="field"><label>í•œê¸€ì„±ëª…</label><div class="val" id="pass-name">-</div></div>
          <div class="field"><label>ì¹­í˜¸</label><div class="val" id="pass-title">ì—†ìŒ</div></div>
          <div class="field"><label>ì‚¬ì§„</label><input id="pass-photo" type="file" accept="image/*" /></div>
          <div class="row">
            <div class="field"><label>ì„±(í•œê¸€)</label><input id="pass-last" type="text" placeholder="ì„±"></div>
            <div class="field"><label>ì´ë¦„(í•œê¸€)</label><input id="pass-first" type="text" placeholder="ì´ë¦„"></div>
          </div>
          <div class="row">
            <div class="field"><label>ìƒë…„ì›”ì¼</label><input id="pass-birth" type="date"></div>
            <div class="field">
              <label>ì„±ë³„</label>
              <select id="pass-gender"><option>ì„ íƒ</option><option>ë‚¨</option><option>ì—¬</option><option>ê¸°íƒ€</option></select>
            </div>
          </div>
          <div class="cta">
            <button class="btn secondary" id="btnSavePass">ì €ì¥</button>
          </div>
        </div>
      </article>
    </div>
    <div class="cta">
      <button class="btn" id="btnConfirm">í™•ì¸</button>
    </div>
  </section>

  <!-- ì§€ë„ í™”ë©´ -->
  <section id="mapwrap" class="screen">
    <div class="top-right">
      <div class="pill" id="pillUser">ì‚¬ìš©ì: -</div>
      <div class="pill" id="pillTitle">ì¹­í˜¸: ì—†ìŒ</div>
      <div class="pill" id="pillFlights">ë¹„í–‰: 0íšŒ</div>
    </div>
    <div id="map" class="map-locked"></div>
    <div class="cta" style="position:fixed;left:12px;bottom:12px;z-index:1000;gap:8px">
      <button class="btn hidden" id="btnTaxi">íƒì‹œ í˜¸ì¶œ</button>
      <button class="btn secondary hidden" id="btnBackAirport">ê³µí•­ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
      <button class="btn secondary hidden" id="btnReturnKorea">ê·€êµ­</button>
    </div>
  </section>

  <!-- ê·€êµ­ í™”ë©´ -->
  <section id="returnwrap" class="screen" style="text-align:center">
    <h2>ëŒ€í•œë¯¼êµ­ ë„ì°©! ğŸ‡°ğŸ‡·</h2>
    <p>ì—¬í–‰ì„ ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
    <div class="cta">
      <button class="btn" id="btnContinue">ê³„ì†í•˜ê¸°</button>
      <button class="btn secondary" id="btnEnd">ì—¬í–‰ ì¢…ë£Œ</button>
    </div>
  </section>

<script>
/* =======================
   1) ê³µí•­ ë°ì´í„° & ì§€ì—­ ë§¤í•‘
   ======================= */
const AIRPORTS = {
  "ëŒ€í•œë¯¼êµ­":[
    {code:"ICN", name:"ì¸ì²œêµ­ì œê³µí•­", lat:37.4602, lng:126.4407},
    {code:"GMP", name:"ê¹€í¬êµ­ì œê³µí•­", lat:37.5583, lng:126.7906},
    {code:"CJU", name:"ì œì£¼êµ­ì œê³µí•­", lat:33.5071, lng:126.4928}
  ],
  "ì¼ë³¸":[
    {code:"NRT", name:"ë„ì¿„ ë‚˜ë¦¬íƒ€ êµ­ì œê³µí•­", lat:35.7719, lng:140.3929},
    {code:"HND", name:"ë„ì¿„ í•˜ë„¤ë‹¤ êµ­ì œê³µí•­", lat:35.5494, lng:139.7798},
    {code:"KIX", name:"ì˜¤ì‚¬ì¹´ ê°„ì‚¬ì´ êµ­ì œê³µí•­", lat:34.4273, lng:135.2441},
    {code:"NGO", name:"ë‚˜ê³ ì•¼ ì£¼ë¶€ êµ­ì œê³µí•­", lat:34.8584, lng:136.8054},
    {code:"FUK", name:"í›„ì¿ ì˜¤ì¹´ êµ­ì œê³µí•­", lat:33.5902, lng:130.4510},
    {code:"CTS", name:"ì‚¿í¬ë¡œ ì‹ ì¹˜í† ì„¸ êµ­ì œê³µí•­", lat:42.7752, lng:141.6923},
    {code:"OKA", name:"ì˜¤í‚¤ë‚˜ì™€ ë‚˜í•˜ êµ­ì œê³µí•­", lat:26.1958, lng:127.6459}
  ],
  "ë² íŠ¸ë‚¨":[
    {code:"SGN", name:"í˜¸ì¹˜ë¯¼ ë–¤ì„ ë‚« êµ­ì œê³µí•­", lat:10.8188, lng:106.6518},
    {code:"HAN", name:"í•˜ë…¸ì´ ë…¸ì´ë°”ì´ êµ­ì œê³µí•­", lat:21.2142, lng:105.8029},
    {code:"DAD", name:"ë‹¤ë‚­ êµ­ì œê³µí•­", lat:16.0439, lng:108.1994},
    {code:"CXR", name:"ë‚˜íŠ¸ë‘ ì¹´ë¬´ë€ êµ­ì œê³µí•­", lat:11.9986, lng:109.2194},
    {code:"PQC", name:"í‘¸ê¾¸ì˜¥ êµ­ì œê³µí•­", lat:10.227, lng:103.967}
  ],
  "ì¤‘êµ­":[
    {code:"PEK", name:"ë² ì´ì§• ì„œìš°ë‘ êµ­ì œê³µí•­", lat:40.0801, lng:116.5846},
    {code:"PKX", name:"ë² ì´ì§• ë‹¤ì‹± êµ­ì œê³µí•­", lat:39.5099, lng:116.4108},
    {code:"PVG", name:"ìƒí•˜ì´ í‘¸ë‘¥ êµ­ì œê³µí•­", lat:31.1443, lng:121.8083},
    {code:"SHA", name:"ìƒí•˜ì´ í™ì°¨ì˜¤ êµ­ì œê³µí•­", lat:31.1979, lng:121.3363},
    {code:"CAN", name:"ê´‘ì €ìš° ë°”ì´ìœˆ êµ­ì œê³µí•­", lat:23.3924, lng:113.2988}
  ],
  "ëŸ¬ì‹œì•„":[
    {code:"SVO", name:"ëª¨ìŠ¤í¬ë°” ì…°ë ˆë©”í‹°ì˜ˆë³´ êµ­ì œê³µí•­", lat:55.9726, lng:37.4146},
    {code:"DME", name:"ëª¨ìŠ¤í¬ë°” ë„ëª¨ë°ë„ë³´ êµ­ì œê³µí•­", lat:55.4146, lng:37.9026},
    {code:"LED", name:"ìƒíŠ¸í˜í…Œë¥´ë¶€ë¥´í¬ í’€ì½”ë³´ êµ­ì œê³µí•­", lat:59.8003, lng:30.2625},
    {code:"VVO", name:"ë¸”ë¼ë””ë³´ìŠ¤í† í¬ êµ­ì œê³µí•­", lat:43.3989, lng:132.1483}
  ],
  "íƒœêµ­":[
    {code:"BKK", name:"ë°©ì½• ìˆ˜ì™„ë‚˜í’ˆ êµ­ì œê³µí•­", lat:13.6900, lng:100.7501},
    {code:"DMK", name:"ë°©ì½• ëˆë¯€ì•™ êµ­ì œê³µí•­", lat:13.9125, lng:100.6067},
    {code:"HKT", name:"í‘¸ì¼“ êµ­ì œê³µí•­", lat:8.1132, lng:98.3168},
    {code:"CNX", name:"ì¹˜ì•™ë§ˆì´ êµ­ì œê³µí•­", lat:18.7668, lng:98.9626},
    {code:"USM", name:"ì½”ì‚¬ë¬´ì´ êµ­ì œê³µí•­", lat:9.5478, lng:100.0614}
  ],
  "ë§ë ˆì´ì‹œì•„":[
    {code:"KUL", name:"ì¿ ì•Œë¼ë£¸í‘¸ë¥´ êµ­ì œê³µí•­", lat:2.7456, lng:101.7072},
    {code:"PEN", name:"í˜ë‚­ êµ­ì œê³µí•­", lat:5.2971, lng:100.2760},
    {code:"LGK", name:"ë‘ì¹´ìœ„ êµ­ì œê³µí•­", lat:6.3297, lng:99.7287},
    {code:"BKI", name:"ì½”íƒ€í‚¤ë‚˜ë°œë£¨ êµ­ì œê³µí•­", lat:5.9372, lng:116.0512}
  ],
  "ì¸ë„ë„¤ì‹œì•„":[
    {code:"CGK", name:"ìì¹´ë¥´íƒ€ ìˆ˜ì¹´ë¥´ë…¸í•˜íƒ€ êµ­ì œê³µí•­", lat:-6.1256, lng:106.6559},
    {code:"DPS", name:"ë°œë¦¬ ë´íŒŒì‚¬ë¥´ êµ­ì œê³µí•­", lat:-8.7482, lng:115.1670},
    {code:"SUB", name:"ìˆ˜ë¼ë°”ì•¼ ì£¼ì•ˆë‹¤ êµ­ì œê³µí•­", lat:-7.3798, lng:112.7870}
  ],
  "í•„ë¦¬í•€":[
    {code:"MNL", name:"ë§ˆë‹ë¼ ë‹ˆë…¸ì´ ì•„í‚¤ë…¸ êµ­ì œê³µí•­", lat:14.5099, lng:121.0136},
    {code:"CEB", name:"ì„¸ë¶€ ë§‰íƒ„ êµ­ì œê³µí•­", lat:10.3093, lng:123.9794},
    {code:"CRK", name:"í´ë½ êµ­ì œê³µí•­", lat:15.1860, lng:120.5603},
    {code:"KLO", name:"ì¹¼ë¦¬ë³´ êµ­ì œê³µí•­(ë³´ë¼ì¹´ì´)", lat:11.6794, lng:122.3760}
  ],
  "ì‹±ê°€í¬ë¥´":[
    {code:"SIN", name:"ì‹±ê°€í¬ë¥´ ì°½ì´ êµ­ì œê³µí•­", lat:1.3644, lng:103.9915}
  ],
  "ë¼ì˜¤ìŠ¤":[
    {code:"VTE", name:"ë¹„ì—”í‹°ì•ˆ ì™“íƒ€ì´ êµ­ì œê³µí•­", lat:17.9883, lng:102.5630}
  ],
  "ìº„ë³´ë””ì•„":[
    {code:"PNH", name:"í”„ë†ˆíœ êµ­ì œê³µí•­", lat:11.5466, lng:104.8440},
    {code:"REP", name:"ì”¨ì— ë¦½ êµ­ì œê³µí•­", lat:13.4081, lng:103.8131}
  ],
  "ë¯¸ì–€ë§ˆ":[
    {code:"RGN", name:"ì–‘ê³¤ êµ­ì œê³µí•­", lat:16.9073, lng:96.1332}
  ],
  "ë¸Œë£¨ë‚˜ì´":[
    {code:"BWN", name:"ë°˜ë‹¤ë¥´ìŠ¤ë¦¬ë¸Œê°€ì™„ êµ­ì œê³µí•­", lat:4.9442, lng:114.9283}
  ],
  "ë¯¸êµ­":[
    {code:"JFK", name:"ë‰´ìš• JFK êµ­ì œê³µí•­", lat:40.6413, lng:-73.7781},
    {code:"LAX", name:"ë¡œìŠ¤ì•¤ì ¤ë ˆìŠ¤ êµ­ì œê³µí•­", lat:33.9416, lng:-118.4085},
    {code:"SFO", name:"ìƒŒí”„ë€ì‹œìŠ¤ì½” êµ­ì œê³µí•­", lat:37.6213, lng:-122.3790},
    {code:"ORD", name:"ì‹œì¹´ê³  ì˜¤í—¤ì–´ êµ­ì œê³µí•­", lat:41.9742, lng:-87.9073},
    {code:"ATL", name:"ì• í‹€ëœíƒ€ êµ­ì œê³µí•­", lat:33.6407, lng:-84.4277},
    {code:"HNL", name:"í˜¸ë†€ë£°ë£¨ êµ­ì œê³µí•­(í•˜ì™€ì´)", lat:21.3187, lng:-157.9225},
    {code:"GUM", name:"ê´Œ êµ­ì œê³µí•­", lat:13.4839, lng:144.7971},
    {code:"SPN", name:"ì‚¬ì´íŒ êµ­ì œê³µí•­", lat:15.119, lng:145.729}
  ],
  "ìºë‚˜ë‹¤":[
    {code:"YYZ", name:"í† ë¡ í†  í”¼ì–´ìŠ¨ êµ­ì œê³µí•­", lat:43.6777, lng:-79.6248},
    {code:"YVR", name:"ë°´ì¿ ë²„ êµ­ì œê³µí•­", lat:49.1951, lng:-123.1779}
  ],
  "ì˜êµ­":[
    {code:"LHR", name:"ëŸ°ë˜ íˆë“œë¡œ êµ­ì œê³µí•­", lat:51.4700, lng:-0.4543}
  ],
  "í”„ë‘ìŠ¤":[
    {code:"CDG", name:"íŒŒë¦¬ ìƒ¤ë¥¼ë“œê³¨ êµ­ì œê³µí•­", lat:49.0097, lng:2.5479}
  ],
  "ë…ì¼":[
    {code:"FRA", name:"í”„ë‘í¬í‘¸ë¥´íŠ¸ êµ­ì œê³µí•­", lat:50.0379, lng:8.5622},
    {code:"MUC", name:"ë®Œí—¨ êµ­ì œê³µí•­", lat:48.3538, lng:11.7861}
  ],
  "ì´íƒˆë¦¬ì•„":[
    {code:"FCO", name:"ë¡œë§ˆ í”¼ìš°ë¯¸ì¹˜ë…¸ êµ­ì œê³µí•­", lat:41.8003, lng:12.2389}
  ],
  "ìŠ¤í˜ì¸":[
    {code:"MAD", name:"ë§ˆë“œë¦¬ë“œ êµ­ì œê³µí•­", lat:40.4983, lng:-3.5676},
    {code:"BCN", name:"ë°”ë¥´ì…€ë¡œë‚˜ êµ­ì œê³µí•­", lat:41.2974, lng:2.0833}
  ],
  "í˜¸ì£¼":[
    {code:"SYD", name:"ì‹œë“œë‹ˆ êµ­ì œê³µí•­", lat:-33.9399, lng:151.1753},
    {code:"MEL", name:"ë©œë²„ë¥¸ êµ­ì œê³µí•­", lat:-37.669, lng:144.841}
  ],
  "ë‰´ì§ˆëœë“œ":[
    {code:"AKL", name:"ì˜¤í´ëœë“œ êµ­ì œê³µí•­", lat:-37.0082, lng:174.7850}
  ],
  "í™ì½©":[
    {code:"HKG", name:"í™ì½© ì²µëì½• êµ­ì œê³µí•­", lat:22.3080, lng:113.9185}
  ],
  "ì•„ëì—ë¯¸ë¦¬íŠ¸":[
    {code:"DXB", name:"ë‘ë°”ì´ êµ­ì œê³µí•­", lat:25.2532, lng:55.3657},
    {code:"AUH", name:"ì•„ë¶€ë‹¤ë¹„ êµ­ì œê³µí•­", lat:24.4330, lng:54.6511}
  ],
  "ì¹´íƒ€ë¥´":[
    {code:"DOH", name:"ë„í•˜ í•˜ë§ˆë“œ êµ­ì œê³µí•­", lat:25.2736, lng:51.6081}
  ],
  "í„°í‚¤":[
    {code:"IST", name:"ì´ìŠ¤íƒ„ë¶ˆ êµ­ì œê³µí•­", lat:41.2753, lng:28.7519},
    {code:"SAW", name:"ì´ìŠ¤íƒ„ë¶ˆ ì‚¬ë¹„í•˜ ê´µì²¸ êµ­ì œê³µí•­", lat:40.8986, lng:29.3092}
  ],
  "ì´ìŠ¤ë¼ì—˜":[
    {code:"TLV", name:"í…”ì•„ë¹„ë¸Œ ë²¤êµ¬ë¦¬ì˜¨ êµ­ì œê³µí•­", lat:32.005, lng:34.8854}
  ],
  "ì‚¬ìš°ë””ì•„ë¼ë¹„ì•„":[
    {code:"JED", name:"ì œë‹¤ í‚¹ì••ë‘˜ì•„ì§€ì¦ˆ êµ­ì œê³µí•­", lat:21.6796, lng:39.1565},
    {code:"RUH", name:"ë¦¬ì•¼ë“œ í‚¹ì¹¼ë¦¬ë“œ êµ­ì œê³µí•­", lat:24.9594, lng:46.7029}
  ],
  "ë¸Œë¼ì§ˆ":[
    {code:"GRU", name:"ìƒíŒŒìš¸ë£¨ ê³¼ë£°ë¥˜ìŠ¤ êµ­ì œê³µí•­", lat:-23.4356, lng:-46.4731},
    {code:"GIG", name:"ë¦¬ìš°ë°ìë„¤ì´ë£¨ ê°ˆë ˆì•™ êµ­ì œê³µí•­", lat:-22.8090, lng:-43.2506}
  ],
  "ì•„ë¥´í—¨í‹°ë‚˜":[
    {code:"EZE", name:"ë¶€ì—ë…¸ìŠ¤ì•„ì´ë ˆìŠ¤ ì—ì„¸ì´ì‚¬ êµ­ì œê³µí•­", lat:-34.8222, lng:-58.5358}
  ],
  "ì¹ ë ˆ":[
    {code:"SCL", name:"ì‚°í‹°ì•„ê³  ì•„ë¥´íˆ¬ë¡œ ë©”ë¦¬ë…¸ ë² ë‹ˆí…ŒìŠ¤ êµ­ì œê³µí•­", lat:-33.3929, lng:-70.7858}
  ],
  "í˜ë£¨":[
    {code:"LIM", name:"ë¦¬ë§ˆ í˜¸ë¥´í—¤ ì°¨ë² ìŠ¤ êµ­ì œê³µí•­", lat:-12.0219, lng:-77.1143}
  ],
  "ì½œë¡¬ë¹„ì•„":[
    {code:"BOG", name:"ë³´ê³ íƒ€ ì—˜ë„ë¼ë„ êµ­ì œê³µí•­", lat:4.7016, lng:-74.1469}
  ],
  "ë‚¨ì•„í”„ë¦¬ì¹´ê³µí™”êµ­":[
    {code:"JNB", name:"ìš”í•˜ë„¤ìŠ¤ë²„ê·¸ OR íƒë³´ êµ­ì œê³µí•­", lat:-26.1337, lng:28.2420},
    {code:"CPT", name:"ì¼€ì´í”„íƒ€ìš´ êµ­ì œê³µí•­", lat:-33.9715, lng:18.6021}
  ],
  "ì´ì§‘íŠ¸":[
    {code:"CAI", name:"ì¹´ì´ë¡œ êµ­ì œê³µí•­", lat:30.1219, lng:31.4056}
  ],
  "ì¼€ëƒ":[
    {code:"NBO", name:"ë‚˜ì´ë¡œë¹„ ì¡°ëª¨ ì¼€ëƒíƒ€ êµ­ì œê³µí•­", lat:-1.3192, lng:36.9278}
  ],
  "ì—í‹°ì˜¤í”¼ì•„":[
    {code:"ADD", name:"ì•„ë””ìŠ¤ì•„ë°”ë°” ë³¼ë ˆ êµ­ì œê³µí•­", lat:8.9779, lng:38.7993}
  ],
  "ëª¨ë¡œì½”":[
    {code:"CMN", name:"ì¹´ì‚¬ë¸”ë‘ì¹´ ë¬´í•¨ë§ˆë“œ5ì„¸ êµ­ì œê³µí•­", lat:33.3675, lng:-7.58997}
  ]
};

const REGION_TO_AIRPORT = {
  "ì„œìš¸":"ICN","ì¸ì²œ":"ICN","ê¹€í¬":"GMP","ì œì£¼":"CJU",
  "ë„ì¿„":"HND","ë‚˜ë¦¬íƒ€":"NRT","ì˜¤ì‚¬ì¹´":"KIX","ë‚˜ê³ ì•¼":"NGO","í›„ì¿ ì˜¤ì¹´":"FUK","ì‚¿í¬ë¡œ":"CTS","ì˜¤í‚¤ë‚˜ì™€":"OKA",
  "í˜¸ì¹˜ë¯¼":"SGN","í•˜ë…¸ì´":"HAN","ë‹¤ë‚­":"DAD","ë‚˜íŠ¸ë‘":"CXR","í‘¸ê¾¸ì˜¥":"PQC",
  "ë² ì´ì§•":"PEK","ë‹¤ì‹±":"PKX","ìƒí•˜ì´":"PVG","í™ì°¨ì˜¤":"SHA","ê´‘ì €ìš°":"CAN",
  "ëª¨ìŠ¤í¬ë°”":"SVO","ìƒíŠ¸í˜í…Œë¥´ë¶€ë¥´í¬":"LED","ë¸”ë¼ë””ë³´ìŠ¤í† í¬":"VVO",
  "ë°©ì½•":"BKK","í‘¸ì¼“":"HKT","ì¹˜ì•™ë§ˆì´":"CNX","ì½”ì‚¬ë¬´ì´":"USM",
  "ì¿ ì•Œë¼ë£¸í‘¸ë¥´":"KUL","í˜ë‚­":"PEN","ë‘ì¹´ìœ„":"LGK","ì½”íƒ€í‚¤ë‚˜ë°œë£¨":"BKI",
  "ìì¹´ë¥´íƒ€":"CGK","ë°œë¦¬":"DPS","ìˆ˜ë¼ë°”ì•¼":"SUB",
  "ë§ˆë‹ë¼":"MNL","ì„¸ë¶€":"CEB","í´ë½":"CRK","ë³´ë¼ì¹´ì´":"KLO",
  "ì‹±ê°€í¬ë¥´":"SIN",
  "ë¹„ì—”í‹°ì•ˆ":"VTE","í”„ë†ˆíœ":"PNH","ì”¨ì— ë¦½":"REP","ì–‘ê³¤":"RGN","ë°˜ë‹¤ë¥´ìŠ¤ë¦¬ë¸Œê°€ì™„":"BWN",
  "ë‰´ìš•":"JFK","ë¡œìŠ¤ì•¤ì ¤ë ˆìŠ¤":"LAX","ìƒŒí”„ë€ì‹œìŠ¤ì½”":"SFO","ì‹œì¹´ê³ ":"ORD","ì• í‹€ëœíƒ€":"ATL","í•˜ì™€ì´":"HNL","ê´Œ":"GUM","ì‚¬ì´íŒ":"SPN",
  "í† ë¡ í† ":"YYZ","ë°´ì¿ ë²„":"YVR",
  "ëŸ°ë˜":"LHR","íŒŒë¦¬":"CDG","í”„ë‘í¬í‘¸ë¥´íŠ¸":"FRA","ë®Œí—¨":"MUC","ë¡œë§ˆ":"FCO","ë§ˆë“œë¦¬ë“œ":"MAD","ë°”ë¥´ì…€ë¡œë‚˜":"BCN",
  "ì‹œë“œë‹ˆ":"SYD","ë©œë²„ë¥¸":"MEL","ì˜¤í´ëœë“œ":"AKL",
  "í™ì½©":"HKG",
  "ë‘ë°”ì´":"DXB","ì•„ë¶€ë‹¤ë¹„":"AUH","ë„í•˜":"DOH","ì´ìŠ¤íƒ„ë¶ˆ":"IST","í…”ì•„ë¹„ë¸Œ":"TLV","ì œë‹¤":"JED","ë¦¬ì•¼ë“œ":"RUH",
  "ìƒíŒŒìš¸ë£¨":"GRU","ë¦¬ìš°ë°ìë„¤ì´ë£¨":"GIG","ë¶€ì—ë…¸ìŠ¤ì•„ì´ë ˆìŠ¤":"EZE","ì‚°í‹°ì•„ê³ ":"SCL","ë¦¬ë§ˆ":"LIM","ë³´ê³ íƒ€":"BOG",
  "ìš”í•˜ë„¤ìŠ¤ë²„ê·¸":"JNB","ì¼€ì´í”„íƒ€ìš´":"CPT","ì¹´ì´ë¡œ":"CAI","ë‚˜ì´ë¡œë¹„":"NBO","ì•„ë””ìŠ¤ì•„ë°”ë°”":"ADD","ì¹´ì‚¬ë¸”ë‘ì¹´":"CMN"
};

function findAirportByRegion(q){
  const code = REGION_TO_AIRPORT[q?.trim()];
  if(code){
    for(const c in AIRPORTS){
      const a = AIRPORTS[c].find(x=>x.code===code);
      if(a) return a;
    }
  }
  // êµ­ê°€ëª…ì¸ ê²½ìš° í•´ë‹¹ êµ­ê°€ ì²« ê³µí•­
  if(AIRPORTS[q?.trim()]) return AIRPORTS[q.trim()][0];
  return null;
}

/* =======================
   2) ìƒíƒœ
   ======================= */
const ICN = AIRPORTS["ëŒ€í•œë¯¼êµ­"][0];
let user = { name:null, title:"ì—†ìŒ", flights:0, memories:0 };
let map, planeMarker, taxiMarker, routeLine;
let currentAirport = ICN;
let destinationAirport = null;
let animLock = false; // ì´ë™ ì¤‘ ì ê¸ˆ

/* =======================
   3) UI ì¤€ë¹„
   ======================= */
const $ = s=>document.querySelector(s);
const $$ = s=>document.querySelectorAll(s);

function show(id){
  $$(".screen").forEach(el=>el.classList.remove("active"));
  $(id).classList.add("active");
}

$("#btnStart").onclick = ()=>{
  $("#today").textContent = new Date().toLocaleDateString("ko-KR");
  $("#ticket-name").textContent = (localStorage.getItem("passportName")||"ì´ë¦„ ë¯¸ì…ë ¥");
  loadPassport();
  show("#pt");
};

$("#btnRegPass").onclick = ()=>{
  const name = $("#inp-name").value.trim();
  if(!name){ alert("ì—¬ê¶Œ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”."); return; }
  localStorage.setItem("passportName", name);
  user.name = name;
  $("#pass-name").textContent = name;
  $("#passport-closed").classList.add("hidden");
  $("#passport-opened").classList.remove("hidden");
  $("#ticket-name").textContent = name;
  $("#pillUser").textContent = "ì‚¬ìš©ì: "+name;
};

$("#btnSavePass").onclick = ()=>{
  // ë‹¨ìˆœ ì €ì¥ (ì¶”í›„ í™•ì¥ ê°€ëŠ¥)
  localStorage.setItem("passportTitle", user.title);
  alert("ì—¬ê¶Œì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
};

function loadPassport(){
  const savedName = localStorage.getItem("passportName");
  const savedTitle = localStorage.getItem("passportTitle")||"ì—†ìŒ";
  if(savedName){
    user.name = savedName; user.title = savedTitle;
    $("#passport-closed").classList.add("hidden");
    $("#passport-opened").classList.remove("hidden");
    $("#pass-name").textContent = savedName;
    $("#pass-title").textContent = savedTitle;
    $("#ticket-name").textContent = savedName;
    $("#pillUser").textContent = "ì‚¬ìš©ì: "+savedName;
    $("#pillTitle").textContent = "ì¹­í˜¸: "+savedTitle;
  }else{
    $("#passport-closed").classList.remove("hidden");
    $("#passport-opened").classList.add("hidden");
  }
}

$("#btnConfirm").onclick = async ()=>{
  const name = user.name || $("#inp-name").value.trim();
  const destText = $("#inp-dest").value.trim();
  if(!name){ alert("ì—¬ê¶Œ ì´ë¦„ì„ ë“±ë¡í•´ì£¼ì„¸ìš”."); return; }
  if(!destText){ alert("ë„ì°©ì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }

  const ap = findAirportByRegion(destText);
  if(!ap){
    alert("ë„ì°©ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ë„ì‹œ/êµ­ê°€/ì§€ì—­ëª…ì„ ë‹¤ì‹œ ì‹œë„)");
    return;
  }
  destinationAirport = ap;
  $("#dest-code").textContent = ap.code;

  show("#mapwrap");
  initMap();
  fly(ICN, ap);
};

/* =======================
   4) ì§€ë„ & ì• ë‹ˆë©”ì´ì…˜
   ======================= */
function initMap(){
  map = L.map('map', { zoomControl:true }).setView([ICN.lat, ICN.lng], 4);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    maxZoom:19, attribution:'&copy; OpenStreetMap'
  }).addTo(map);

  // ì´ˆê¸° ì ê¸ˆ
  lockMap(true);
  updatePills();
}

function lockMap(lock){
  animLock = lock;
  const m = $("#map");
  if(lock){ m.classList.add("map-locked"); }
  else{ m.classList.remove("map-locked"); }
  if(lock){
    map.dragging.disable();
    map.scrollWheelZoom.disable();
    map.doubleClickZoom.disable();
    map.boxZoom.disable();
    map.keyboard.disable();
  }else{
    map.dragging.enable();
    map.scrollWheelZoom.enable();
    map.doubleClickZoom.enable();
    map.boxZoom.enable();
    map.keyboard.enable();
  }
}

function makePlaneDivIcon(master=false){
  const className = master ? "plane master" : "plane";
  return L.divIcon({ className, iconSize:[60,60] });
}

function bearing(a,b){
  const toRad = d=>d*Math.PI/180;
  const y = Math.sin(toRad(b.lng-a.lng)) * Math.cos(toRad(b.lat));
  const x = Math.cos(toRad(a.lat))*Math.sin(toRad(b.lat)) -
            Math.sin(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.cos(toRad(b.lng-a.lng));
  let brng = Math.atan2(y,x)*180/Math.PI;
  return (brng+360)%360;
}

async function fly(from, to){
  lockMap(true);
  $("#btnTaxi").classList.add("hidden");
  $("#btnBackAirport").classList.add("hidden");
  $("#btnReturnKorea").classList.add("hidden");

  const planeIcon = makePlaneDivIcon(user.title.includes("íŠ¸ë˜ë¸” ë§ˆìŠ¤í„°"));
  if(planeMarker) map.removeLayer(planeMarker);
  planeMarker = L.marker([from.lat, from.lng], { icon: planeIcon, interactive:false }).addTo(map);

  const totalMs = 15000, steps = 120, dt = totalMs/steps;
  let step = 0;
  const fromLatLng = {lat:from.lat, lng:from.lng};
  const toLatLng = {lat:to.lat, lng:to.lng};

  map.setView([from.lat, from.lng], 4);

  const interval = setInterval(()=>{
    step++;
    const t = step/steps;
    const lat = from.lat + (to.lat-from.lat)*t;
    const lng = from.lng + (to.lng-from.lng)*t;

    // íšŒì „
    const br = bearing({lat,lng},{lat:to.lat,lng:to.lng});
    const el = planeMarker.getElement();
    if(el) el.style.transform = `rotate(${br}deg)`;

    planeMarker.setLatLng([lat,lng]);

    if(step>=steps){
      clearInterval(interval);
      // ë„ì°©
      user.flights++;
      updateTitlesByFlights();
      currentAirport = to;
      map.setView([to.lat, to.lng], 12);
      // ë¹„í–‰ ì¢…ë£Œì‹œ ì§€ë„ ê³ ì • ìœ ì§€
      lockMap(true);
      // íƒì‹œ ë²„íŠ¼ í‘œì‹œ
      $("#btnTaxi").classList.remove("hidden");
    }
  }, dt);
}

function updatePills(){
  $("#pillUser").textContent = "ì‚¬ìš©ì: " + (user.name||"-");
  $("#pillTitle").textContent = "ì¹­í˜¸: " + (user.title||"ì—†ìŒ");
  $("#pillFlights").textContent = "ë¹„í–‰: " + (user.flights||0) + "íšŒ";
}

function updateTitlesByFlights(){
  // 30íšŒë§ˆë‹¤ ë­í¬ì—… êµ¬ì¡° (ê°„ë‹¨ ë‹¨ê³„ ì˜ˆì‹œ)
  let t = "ì—†ìŒ";
  if(user.flights >= 150) t = "íŠ¸ë˜ë¸” ë§ˆìŠ¤í„°";
  else if(user.flights >= 120) t = "ì—˜ë¦¬íŠ¸ ì—¬í–‰ê°€";
  else if(user.flights >= 90) t = "í”„ë¡œ ì—¬í–‰ê°€";
  else if(user.flights >= 60) t = "ì•„ë§ˆì¶”ì–´ ì—¬í–‰ê°€";
  else if(user.flights >= 30) t = "ë£¨í‚¤ ì—¬í–‰ê°€";
  else if(user.flights >= 1) t = "ì´ˆë³´ ì—¬í–‰ê°€";

  user.title = t;
  localStorage.setItem("passportTitle", t);
  $("#pass-title").textContent = t;
  updatePills();
}

/* =======================
   5) íƒì‹œ ì‹œìŠ¤í…œ
   ======================= */
$("#btnTaxi").onclick = async ()=>{
  if(animLock) return;
  askTaxiDestination();
};

async function askTaxiDestination(){
  const where = prompt("ì–´ë””ë¡œ ê°€ì‹œê² ì–´ìš”? (ì˜ˆ: í˜¸ì¹˜ë¯¼ / ì‹ ì£¼ì¿  / Notre Dame Cathedral)");
  if(!where) return;

  // 1) ê³µí•­/ì§€ì—­ ë§¤í•‘ ìš°ì„ 
  const ap = findAirportByRegion(where);
  if(ap){
    // ë„ì‹œ ì¤‘ì•™ ëŒ€ì‹  ê³µí•­ì´ë©´, ê³µí•­ì—ì„œ ì¡°ê¸ˆ ë²—ì–´ë‚œ í¬ì¸íŠ¸ë¡œ ì´ë™
    const target = { lat: ap.lat + 0.04, lng: ap.lng + 0.04, label: ap.name };
    return moveTaxiTo(target);
  }

  // 2) ì§€ì˜¤ì½”ë”© (Nominatim)
  try{
    const q = encodeURIComponent(where);
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${q}`;
    const res = await fetch(url, { headers: { "Accept-Language":"ko" }});
    const arr = await res.json();
    if(arr && arr.length){
      const p = arr[0];
      return moveTaxiTo({ lat: parseFloat(p.lat), lng: parseFloat(p.lon), label: p.display_name });
    }else{
      alert("ì§€ëª…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ í‘œí˜„ìœ¼ë¡œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
    }
  }catch(e){
    console.error(e);
    alert("ì§€ì˜¤ì½”ë”© ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
}

async function moveTaxiTo(target){
  // íƒì‹œ ìŠ¤í° (ê³µí•­ ìœ„ì¹˜)
  if(taxiMarker) map.removeLayer(taxiMarker);
  taxiMarker = L.marker([currentAirport.lat, currentAirport.lng], {
    icon: L.divIcon({ className:"taxi", iconSize:[50,50] }),
    interactive:false
  }).addTo(map);

  // OSRM ê²½ë¡œ ìš”ì²­ (ë„ë¡œ ë”°ë¼ ì´ë™)
  try{
    lockMap(true);
    $("#btnTaxi").classList.add("hidden");
    $("#btnBackAirport").classList.add("hidden");
    $("#btnReturnKorea").classList.add("hidden");

    const start = `${currentAirport.lng},${currentAirport.lat}`;
    const end   = `${target.lng},${target.lat}`;
    const url = `https://router.project-osrm.org/route/v1/driving/${start};${end}?overview=full&geometries=geojson`;
    const res = await fetch(url);
    const data = await res.json();

    if(!data.routes || !data.routes.length){
      // ê²½ë¡œ ì—†ìœ¼ë©´ ì§ì„  ì´ë™
      return animateTaxiLinear([currentAirport.lat, currentAirport.lng], [target.lat, target.lng]);
    }

    const coords = data.routes[0].geometry.coordinates.map(([x,y])=>[y,x]);
    if(routeLine) map.removeLayer(routeLine);
    routeLine = L.polyline(coords, { color:'#003478', weight:4, opacity:.6 }).addTo(map);
    map.fitBounds(routeLine.getBounds(), { padding:[50,50] });

    // 15ì´ˆì— ë§ì¶° ê²½ë¡œ ì• ë‹ˆë©”ì´ì…˜
    const totalMs = 15000;
    const steps = coords.length;
    const dt = totalMs / steps;

    let i = 0;
    const timer = setInterval(()=>{
      if(i>=coords.length){
        clearInterval(timer);
        map.removeLayer(routeLine);
        arriveCity(target);
        return;
      }
      taxiMarker.setLatLng(coords[i]);
      i++;
    }, dt);

  }catch(e){
    console.error(e);
    // ì‹¤íŒ¨ ì‹œ ì§ì„  ì´ë™
    animateTaxiLinear([currentAirport.lat, currentAirport.lng], [target.lat, target.lng]);
  }
}

function animateTaxiLinear(from, to){
  const totalMs = 15000, steps = 120, dt = totalMs/steps;
  let step=0;
  const timer = setInterval(()=>{
    step++;
    const t = step/steps;
    const lat = from[0] + (to[0]-from[0])*t;
    const lng = from[1] + (to[1]-from[1])*t;
    taxiMarker.setLatLng([lat,lng]);
    if(step>=steps){
      clearInterval(timer);
      arriveCity({lat:to[0], lng:to[1], label:"ëª©ì ì§€"});
    }
  }, dt);
}

function arriveCity(target){
  lockMap(false); // ë„ì°© í›„ ììœ  ìŠ¤í¬ë¡¤/ì¤Œ í—ˆìš©
  map.setView([target.lat, target.lng], 14);
  alert("ë„ì°©í–ˆìŠµë‹ˆë‹¤! ì¶”ì–µì„ ë“±ë¡í•´ ë³´ì„¸ìš”.");
  $("#btnBackAirport").classList.remove("hidden");
  $("#btnReturnKorea").classList.remove("hidden");
}

/* ê³µí•­ ë³µê·€ & ê·€êµ­ */
$("#btnBackAirport").onclick = ()=>{
  lockMap(true); // ê³µí•­ìœ¼ë¡œ ì´ë™í•˜ëŠ” ë™ì•ˆ ì ê¸ˆ
  if(routeLine) map.removeLayer(routeLine);
  if(taxiMarker) taxiMarker.setLatLng([currentAirport.lat, currentAirport.lng]);
  map.setView([currentAirport.lat, currentAirport.lng], 12);
  setTimeout(()=>{
    lockMap(true);
    $("#btnTaxi").classList.remove("hidden");
    $("#btnBackAirport").classList.add("hidden");
    $("#btnReturnKorea").classList.remove("hidden");
  }, 400);
};

$("#btnReturnKorea").onclick = ()=>{
  // ê·€êµ­: í˜„ì¬ ê³µí•­ -> ì¸ì²œ ë¹„í–‰ (15ì´ˆ)
  fly(currentAirport, ICN);
  // ë„ì°© í›„ í™”ë©´ ì „í™˜
  setTimeout(()=>{
    show("#returnwrap");
    lockMap(true);
    $("#btnTaxi").classList.add("hidden");
    $("#btnBackAirport").classList.add("hidden");
    $("#btnReturnKorea").classList.add("hidden");
  }, 15500);
};

$("#btnContinue").onclick = ()=>{
  show("#pt");
  $("#inp-dest").value = "";
  $("#dest-code").textContent = "???";
  $("#ticket-name").textContent = user.name||"ì´ë¦„ ë¯¸ì…ë ¥";
  $("#today").textContent = new Date().toLocaleDateString("ko-KR");
};

$("#btnEnd").onclick = ()=>{
  // ì—¬í–‰ ì¢…ë£Œ: ì´ˆê¸°í™”ëŠ” ë¹„í–‰ íšŸìˆ˜ë§Œ ìœ ì§€/ë˜ëŠ” í•„ìš”ì‹œ ì´ˆê¸°í™”
  show("#start");
};

/* ì²˜ìŒ ì§„ì… ì‹œ ë‚ ì§œ ì„¸íŒ… */
document.addEventListener("DOMContentLoaded", ()=>{
  $("#today").textContent = new Date().toLocaleDateString("ko-KR");
});
</script>
</body>
</html>